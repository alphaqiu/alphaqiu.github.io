<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"alpha.checkitout.dev","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
<meta property="og:type" content="website">
<meta property="og:title" content="Check it out">
<meta property="og:url" content="https://alpha.checkitout.dev/index.html">
<meta property="og:site_name" content="Check it out">
<meta property="og:description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="alpha">
<meta property="article:tag" content="checkitout.dev">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://alpha.checkitout.dev/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>Check it out</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-151212624-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-151212624-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Check it out</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">工作笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/404.html" rel="section"><i class="fa fa-fw fa-heartbeat"></i>公益 404</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/alphaqiu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/proxy-re-encrypt">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/proxy-re-encrypt" class="post-title-link" itemprop="url">代理重加密</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-10-04 20:28:45 / 修改时间：21:11:54" itemprop="dateCreated datePublished" datetime="2023-10-04T20:28:45+08:00">2023-10-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/proxy-re-encrypt#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="/proxy-re-encrypt" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="公钥直接加密法"><a href="#公钥直接加密法" class="headerlink" title="公钥直接加密法"></a>公钥直接加密法</h2><p>我们先来看看如果直接进行数据分享，有没有什么简单的方法。下面以Alice（数据拥有者）向Bob（数据接收者）分享一份文件为例，说明公钥直接加密法。</p>
<p>1、Alice使用Bob的公钥对文件进行加密。</p>
<p>2、将数据分享给Bob。</p>
<p>3、Bob解密文件，获取信息。</p>
<p>这个过程简单而直接，这就是公钥直接加密法。但如果面对使用存储网络进行数据分享的情况公钥直接加密法有没有优势呢？</p>
<p>由于数据存储在存储网络中，且自己的私钥不能泄漏，所以Alice需要先下载文件，解密、重新使用Bob的公钥加密再上传到存储网络中，然后Bob可以从存储网络中获取文件。</p>
<p>还有一个问题，如果Alice有一天又想把数据分享给Julia，那么他需要再重新将上面的操作进行一遍。</p>
<p>分析上面的问题，我们其实只使用了存储网络的存储功能，而没有使用存储网络的计算功能。所以“直接公钥加密”是一种非常笨拙的方法。</p>
<h2 id="代理重加密-Proxy-Re-Encryption-简称PRE"><a href="#代理重加密-Proxy-Re-Encryption-简称PRE" class="headerlink" title="代理重加密(Proxy Re-Encryption, 简称PRE)"></a>代理重加密(Proxy Re-Encryption, 简称PRE)</h2><p>代理重加密（Proxy Re-Encryption）是一种密码学技术，用于在保持数据的机密性的同时，允许一个代理将加密数据从一个密钥（发送者密钥）转换为另一个密钥（接收者密钥），而无需解密和重新加密数据。</p>
<p>代理重加密的工作方式如下：</p>
<ol>
<li>发送者生成一对非对称密钥，包括公钥和私钥。发送者使用公钥将数据进行加密，并将加密后的数据发送给代理。</li>
<li>代理在接收到加密数据后，使用代理密钥对数据进行重加密。代理密钥是由代理生成的，与发送者和接收者的密钥相关联。重加密的过程允许代理将数据从发送者密钥转换为接收者密钥，而无需解密数据内容。</li>
<li>接收者使用自己的私钥解密代理重加密后的数据，以获取原始的明文数据。</li>
</ol>
<p>代理重加密的主要优势在于，它允许数据所有者（发送者）委托一个代理来转发加密数据给接收者，而无需泄露自己的私钥或要求代理解密数据。这种委托可以在不破坏数据机密性的前提下进行，因为代理只是在加密域中进行转换操作，而不需要访问数据的明文内容。</p>
<p>代理重加密在很多场景中都有应用，如安全数据共享、云存储、跨域认证和密钥管理等。它提供了一种灵活且安全的方式，使得数据所有者能够控制数据的访问权限，并在需要时委托代理进行数据的转发和解密操作，同时确保数据的机密性得到保护。</p>
<h2 id="代理重加密的特点"><a href="#代理重加密的特点" class="headerlink" title="代理重加密的特点"></a>代理重加密的特点</h2><p>(1).单向性 (Unidirectional): 在代理重加密方案中，如果代理者仅仅能将授权者的密文转化成受理者的密文，而不能将受理者的密文转化成授权者的密文，则称该方案是单向的。反之如果代理者既能够将授权者的密文转换成受理者的密文，也能够将受理者的密文转化成授权者的密文，则该方案称为双向的(bidirectional)。显然在代理重加密方案中，单向代理重加密方案比双向代理重加密方案更优越。首先，在实际应用中，这种授权关系往往不是双向的。其次双向的代理重加密方案可以有两个单向的代理重加密方案构造，反之单向代理重加密则不能由双向单向代理重加密获得。</p>
<p>(2).多用性 (Multi-use): 在单向代理重加密方案中，如果已经被重加密的密文还能被代理者重加密，则称为多用代理重加密。反之，如果已经被加密的密文不能再被代理者重加密，则称为单用 (single-use) 单向代理重加密。</p>
<p>(3).非交互性(Non-interactive): 在单向代理重加密方案中，授权者在产生代理重加密密钥的过程中不需要受理者或者其他第三方的参与，则称为非交互性代理重加密。反之，如果授权者需要与受理者或者其他第三方交互来产生代理重加密密钥，则称为交互式 (Interavtive)代理重加密。</p>
<p>(4).透明性 (Transparent): 在代理重加密方案中，如果代理者是透明的，即发送者和受理者都不知道代理者的存在，则称该代理重加密方案是透明的。在透明代理重加密方案中，重加密后发送给受理者的密文与原本就发送给受理者的密文是不可区分的。</p>
<p>(5).密钥最优(Key optimal): 在代理重加密方案中，如果受理者所需要存储的私钥是固定的，并不因为该受理者可能是多个授权者的受理者而增加。则称该代理重加密方案是密钥最优的。</p>
<p>(6).非传递性(Non-transitive): 在代理重加密方案中，如果代理者拥有将 Alice 的密文转化成 Bob 的密文的代理重加密密钥rka-B和将 Bob 的密文转化成 Carlo 的密文的代理重加密钥rkB-C，但是代理者不能够自己计算出将 Alice 的密文转化成 Carlo 的密文的代理重加密密钥rkA-C，则该代理重加密方案是非传递性的。</p>
<p>(7).非转移性(Non-transferable): 在代理重加密方案中，如果代理者拥有将 Alice 的密文转化成 Bob 的密文的代理重加密密钥rkA-B，即使代理者和受理者合谋，也不能够获得将Alice 的密文转化成 Carlo 的密文的代理重加密密钥rkA-C，则该代理重加密方案是非转移性的注意，非传递性指代理者自己不能生成新的代理重加密密钥，而非转移性指，代理者不能和受理者合谋生成新的代理重加密密钥。</p>
<p>(8).临时性 (Temporary): 在代理重加密方案中，授权者授权代理者重加密自己的密钥,这种授权关系是只是在一定的时间范围内有效，或者授权者可以通过某种机制去撤销这种授权关系，则称该代理重加密方案是临时的。</p>
<p>(9).抗合谋 (Collusion resistant): 在代理重加密方案中，即使代理者和授权者合谋，也不能够获得授权者的私钥，则称该代理重加密方案是抗合谋的。显然如果一个代理重加密方案是非转移的，则该代理重加密方案是抗合谋的，反之则不然。</p>
<p>(10)源隐藏(Source hiding): 在代理重加密方案中，如果攻击者 (包括受理者) 无法确定某个原始密文是否是某个重加密密文的原密文，则称该代理重加密方案是源隐藏的。</p>
<h2 id="代理重加密的一种方案"><a href="#代理重加密的一种方案" class="headerlink" title="代理重加密的一种方案"></a>代理重加密的一种方案</h2><p>本文涉及的代理重加密，并不会对要加密的原文进行二次加密，而是对原文进行加密的密码进行加密。参与重加密的服务器无法得知加密密码，因此密文可以保存在服务器端存储，且不会泄露任何信息。服务器对加密后的密码重加密，授权一侧的用户通过自身的私钥进行密码解析，从而对密文进行反加密。</p>
<h3 id="常用符号"><a href="#常用符号" class="headerlink" title="常用符号"></a>常用符号</h3><p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="3.185ex" height="1.439ex" role="img" focusable="false" viewBox="0 -442 1407.7 636"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(503,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(947.7,0)"><path data-c="1D45E" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container>表示大素数，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.869ex;" xmlns="http://www.w3.org/2000/svg" width="2.741ex" height="2.434ex" role="img" focusable="false" viewBox="0 -691.8 1211.6 1076"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mo" transform="translate(808,363) scale(0.707)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mi" transform="translate(716,-247) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g></g></g></svg></mjx-container>表示集合{<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="13.344ex" height="1.946ex" role="img" focusable="false" viewBox="0 -666 5898.1 860"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(500,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(944.7,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(1444.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(1889.3,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(3228,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(3672.7,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(4397.9,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(5398.1,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></svg></mjx-container>}</p>
<p>G表示阶数为素数的有限域上的循环群，g表示群G的生成元。</p>
<p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="7.418ex" height="2.977ex" role="img" focusable="false" viewBox="0 -1294 3278.6 1316"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="REL" transform="translate(746.8,0)"><g data-mml-node="mover"><g data-mml-node="TeXAtom" data-mjx-texclass="OP"><g data-mml-node="mo"><path data-c="27F5" d="M165 270H1510Q1525 262 1525 250T1510 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270Z"></path></g></g><g data-mml-node="TeXAtom" transform="translate(536.2,711) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g></g></g></g><g data-mml-node="mi" transform="translate(2633.6,0)"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g></g></g></svg></mjx-container> 表示元素s是从集合S中随机选取。</p>
<h3 id="算法逻辑"><a href="#算法逻辑" class="headerlink" title="算法逻辑"></a>算法逻辑</h3><p>Alice 和Bob 分别有属于自己的公私钥对。</p>
<p>Alice (<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.355ex;" xmlns="http://www.w3.org/2000/svg" width="3.274ex" height="1.926ex" role="img" focusable="false" viewBox="0 -694 1447.1 851.1"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="msub" transform="translate(469,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g></g></g></g></svg></mjx-container>, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="3.351ex" height="2.009ex" role="img" focusable="false" viewBox="0 -694 1481.1 888"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="msub" transform="translate(503,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g></g></g></g></svg></mjx-container>, 其中<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.869ex;" xmlns="http://www.w3.org/2000/svg" width="10.912ex" height="3.797ex" role="img" focusable="false" viewBox="0 -1294 4823.2 1678.1"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="msub" transform="translate(469,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="REL" transform="translate(1724.8,0)"><g data-mml-node="mover"><g data-mml-node="TeXAtom" data-mjx-texclass="OP"><g data-mml-node="mo"><path data-c="27F5" d="M165 270H1510Q1525 262 1525 250T1510 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270Z"></path></g></g><g data-mml-node="TeXAtom" transform="translate(536.2,711) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g></g></g></g><g data-mml-node="msubsup" transform="translate(3611.6,0)"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mo" transform="translate(808,363) scale(0.707)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mi" transform="translate(716,-247) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g></g></g></svg></mjx-container> , <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.355ex;" xmlns="http://www.w3.org/2000/svg" width="3.274ex" height="1.926ex" role="img" focusable="false" viewBox="0 -694 1447.1 851.1"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="msub" transform="translate(469,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g></g></g></g></svg></mjx-container>是私钥，从大素数有限域中随机挑选的一个数，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="3.351ex" height="2.009ex" role="img" focusable="false" viewBox="0 -694 1481.1 888"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="msub" transform="translate(503,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g></g></g></g></svg></mjx-container>是公钥)。</p>
<p>Bob(<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="7.311ex" height="2.009ex" role="img" focusable="false" viewBox="0 -694 3231.4 888"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="msub" transform="translate(469,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g><g data-mml-node="mo" transform="translate(1376.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1821,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="msub" transform="translate(2324,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></g></svg></mjx-container>, 其中<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.869ex;" xmlns="http://www.w3.org/2000/svg" width="10.752ex" height="3.797ex" role="img" focusable="false" viewBox="0 -1294 4752.5 1678.1"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="msub" transform="translate(469,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="REL" transform="translate(1654.1,0)"><g data-mml-node="mover"><g data-mml-node="TeXAtom" data-mjx-texclass="OP"><g data-mml-node="mo"><path data-c="27F5" d="M165 270H1510Q1525 262 1525 250T1510 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270Z"></path></g></g><g data-mml-node="TeXAtom" transform="translate(536.2,711) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g></g></g></g><g data-mml-node="msubsup" transform="translate(3540.9,0)"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mo" transform="translate(808,363) scale(0.707)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mi" transform="translate(716,-247) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g></g></g></svg></mjx-container>, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="3.191ex" height="2.009ex" role="img" focusable="false" viewBox="0 -694 1410.3 888"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="msub" transform="translate(503,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></g></svg></mjx-container>是公钥)。</p>
<p>一、Alice 使用自己的公钥创造一个加密密码和加密密码胶囊（胶囊中有加密密码由本次执行所创造的证明）</p>
<p><strong>h is a function that calculate hash on the curve</strong></p>
<p><strong>加密密码胶囊</strong></p>
<script type="math/tex; mode=display">
capsule = \left\{
\begin{array}{**lr**}
E = g * e, & e \stackrel{R}\longleftarrow Z_p^* \\
V = g * v, & v \stackrel{R}\longleftarrow Z_p^* \\
S = v + e * (h(E||V)) \\
\end{array}
\right.</script><p><strong>加密密码</strong></p>
<script type="math/tex; mode=display">
key = sha3(pk_a * (e + v)), e \stackrel{R}\longleftarrow Z_p^*, v \stackrel{R}\longleftarrow Z_p^*</script><p>二、Alice为Bob授权，生成授权公钥和提供给服务器侧的重加密密钥</p>
<script type="math/tex; mode=display">
\left\{
\begin{array}{**lr**}
pubAuthKey = g * authKey, & authKey \stackrel{R}\longleftarrow Z_p^* \\
d = h(pubAuthKey || pk_b || (authKey * pk_b)), \\
r_k = sk_a * (d^{-1}) \\
\end{array}
\right.</script><p>由于authKey是授权时生成的授权密钥，d值也是映射到椭圆曲线上的点，当alice的私钥和d值进行乘法计算，得到的结果<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.042ex" height="1.357ex" role="img" focusable="false" viewBox="0 -442 902.4 599.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(484,-150) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></g></svg></mjx-container>将隐藏Alice私钥的细节。authKey的将被丢弃，对外只输出pubAuthKey，想要还原<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="14.113ex" height="2.034ex" role="img" focusable="false" viewBox="0 -694 6237.8 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(529,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1101,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(1462,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(2038,0)"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mi" transform="translate(2927,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(3393,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(4105.2,0)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mi" transform="translate(4827.4,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="msub" transform="translate(5330.4,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></g></svg></mjx-container>的值，只有Bob的私钥+pubAuthKey才能做到。</p>
<p>三、服务器端进行重加密</p>
<p>检查胶囊中E,V,S是否能够通过验证</p>
<script type="math/tex; mode=display">
\because S = v + e * h(E||V)</script><script type="math/tex; mode=display">
\therefore  g * S = g * (v + e * h(E||V)) = g * v + g * e * h(E||V)</script><script type="math/tex; mode=display">
\because V = g * v, E = g * E</script><script type="math/tex; mode=display">
\therefore  g * S = V + E * h(E||V)</script><p> 根据素数有限域群的交换律，分别计算$g<em>s<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 1000 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">和</text></g></g></g></svg></mjx-container>V+E</em>h(E||V)$在椭圆曲线上的点是否重合，如果相等，证明本次胶囊有效，进行服务端重加密。</p>
<script type="math/tex; mode=display">
newCapsule = \left\{
\begin{array}{**lr**}
E' = E * r_k \\
V' = V * r_k \\
S = oldCapsule.S
\end{array}
\right.</script><p>四、Bob 获取加密密码，需要<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="29.983ex" height="2.084ex" role="img" focusable="false" viewBox="0 -716 13252.7 921"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="msub" transform="translate(469,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(554,-150) scale(0.707)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g><g data-mml-node="mo" transform="translate(1376.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1821,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mi" transform="translate(2324,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(2896,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mi" transform="translate(3325,0)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mi" transform="translate(4075,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(4647,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(5008,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(5584,0)"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mi" transform="translate(6473,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(6939,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(7429,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(7873.7,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(8473.7,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(8939.7,0)"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mi" transform="translate(9655.7,0)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mi" transform="translate(10415.7,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(10944.7,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mi" transform="translate(11447.7,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(11916.7,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(12488.7,0)"><path data-c="1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path></g><g data-mml-node="mi" transform="translate(12786.7,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g></g></g></svg></mjx-container> 这三样东西。</p>
<script type="math/tex; mode=display">
\because sk_b * pubAuthKey = sk_b * (g * authKey)</script><script type="math/tex; mode=display">
\therefore sk_b * pubAuthKey = (sk_b * g) * authKey = pk_b * authKey</script><script type="math/tex; mode=display">
d = h(pubAuthKey || pk_b || (sk_b * pubAuthKey))</script><script type="math/tex; mode=display">
key = pk_a*(e+v)=sk_a*g*(e+v)=sk_a*(e*g+v*g)=sk_a*(E+V)=sk_a*E+sk_a*V</script><script type="math/tex; mode=display">
=d *d^{-1} * (E*sk_a+V*sk_a)=d*(E*sk_a*d^{-1} + V*sk_a*d^{-1})</script><script type="math/tex; mode=display">
\because sk_a * d^{-1} = r_k</script><script type="math/tex; mode=display">
\therefore key = d * (E * r_k + V * r_k) = sha3(d * (E' + V'))</script><p>五、Alice自己也可以根据胶囊信息恢复出加密密码。</p>
<p>根据第四步骤中推演的结果</p>
<script type="math/tex; mode=display">
key = sha3(sk_a * (E + V))</script><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000038338375">使用代理重加密+PlatONE，来保证数据可信、安全地共享</a></p>
<p><a target="_blank" rel="noopener" href="https://www.doc88.com/p-2703873549583.html">代理重加密若干问题研究</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/asecuritysite-when-bob-met-alice/proxy-re-encryption-allowing-alice-to-share-her-protect-secret-key-with-bob-e2a7d0f9d4dd">Proxy Re-Encryption — Allowing Alice To Share Her Protect Secret Key With Bob</a></p>
<p><a target="_blank" rel="noopener" href="https://spqrlab1.github.io/papers/ateniese-proxy-reenc-ndss05.pdf">Improved Proxy Re-Encryption Schemes with Applications to Secure Distributed Storage</a></p>
<p><a target="_blank" rel="noopener" href="https://whisker17.github.io/2020/08/12/pre/">代理重加密综述</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/550105320">代理重加密</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/auto-create-partition-tables">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/auto-create-partition-tables" class="post-title-link" itemprop="url">基于PG自动创建分区表的一种实现</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-01-31 19:45:41 / 修改时间：19:51:49" itemprop="dateCreated datePublished" datetime="2023-01-31T19:45:41+08:00">2023-01-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%AE%E5%8A%A9%E6%89%8B%E5%86%8C/" itemprop="url" rel="index"><span itemprop="name">帮助手册</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/auto-create-partition-tables#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="/auto-create-partition-tables" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>PostgreSQL 是一个现代化的数据库，开源，免费试用，社区活跃，和Oracle具有同等强大的功能。支持JSON格式和自定义类型，支持并行查询，聚合函数、窗口函数和数据透视表非常适合作为统计数据的数据源。</p>
<p>合理规划数据是作为数据库使用的重要手段。目前Filscan作为首款后端使用PostgreSQL数据库的项目，目前已经支撑了亿级以上的Filecoin庞大数据量，后续随着Filecoin链继续发展，数据还将继续膨胀。</p>
<p>Filecoin的状态数据的数量非常庞大，如果在一张表内保存，会非常影响查询效率。为达到保存一段时间内的数据，且可以根据时间范围伸缩，提高查询效率，需要对巨量数据表进行表分区。让数据库按需自动的创建新的表来存放按照规则划分的数据，是可以提高自动化维护表程度，减少人为的干扰和出错的可能。</p>
<h1 id="表分区方案"><a href="#表分区方案" class="headerlink" title="表分区方案"></a>表分区方案</h1><p>表分区方案是一直存在的，有三种方式：</p>
<p><strong>预先创建一批分区表</strong></p>
<p>这种方式最大的弊端是需要定期的创建一批新分区表以适应新数据范围分区，其次分区表不能按实际数据区间创建分区表，所有的数据范围都必须紧密存在，才不会漏存对应的数据到分区中。定期创建分区是容易被忽视的一个环节，一旦忘记定期创建，尤其是定期周期较长，就会导致数据丢失。如果有默认分区存在，新表记录会被保存到默认分区内，对后续可持续维护带来了额外的停机时间开销。</p>
<p><strong>使用程序对表进行分区</strong></p>
<p>这种方式没有问题，不过需要做一些额外适配工作，以适应不同的分区表的动态创建，分区表逻辑的更新依赖程序的更新。而基于数据库实现自动表分区，只需要即时更新存储过程或函数就可立即生效，也能够享受数据库自身的特性带来的便捷性，减少开发周期，降低维护成本。</p>
<p><strong>第三方插件</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/postgrespro/pg_pathman">pg_pathman</a> 是一个PostgreSQL数据库的第三方插件。该插件的好处是封装实现了一套维护分区表的完整操作。阿里云RDS PostgreSQL版本支持安装该插件，下面是阿里云RDS各个PostgreSQL版本所支持该插件的情况。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>插件名</th>
<th>14</th>
<th>13</th>
<th>12</th>
<th>11</th>
<th>10</th>
<th>9.4</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>pg_pathman</td>
<td>无</td>
<td>1.5</td>
<td>1.5</td>
<td>1.5</td>
<td>1.5</td>
<td>无</td>
<td>高性能分区表插件</td>
</tr>
</tbody>
</table>
</div>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/142340.html">https://help.aliyun.com/document_detail/142340.html</a></p>
<p>这里有关于该插件的全部用法：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/140900.html">https://help.aliyun.com/document_detail/140900.html</a></p>
<p>但是该插件官网做了以下提示：</p>
<blockquote>
<h3 id="注意：该项目不再处于开发阶段"><a href="#注意：该项目不再处于开发阶段" class="headerlink" title="注意：该项目不再处于开发阶段"></a>注意：该项目不再处于开发阶段</h3><p><code>pg_pathman</code>支持 Postgres 版本 [9.5..13]，但很可能不会移植到 14 及更高版本。<a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/current/ddl-partitioning.html">声明式分区</a>现在已经相当成熟，几乎所有的东西都在<code>pg_pathman</code>; 我们鼓励用户切换到它。我们仍在维护该项目（修复受支持版本中的错误），但这里不会发生新的开发。</p>
</blockquote>
<p>这个项目官方预计停止后续的支持，目前处于维护阶段，提示官方声明式分区版本已经做得足够好，可以不需要依赖第三方插件。从这点上说，选择声明式分区无疑是最优的选择，不会因为服务器版本升级而需要额外升级依赖第三方实现。</p>
<h1 id="声明式分区（DDL-Partition）"><a href="#声明式分区（DDL-Partition）" class="headerlink" title="声明式分区（DDL-Partition）"></a>声明式分区（DDL-Partition）</h1><p>PostgreSQL提供了一种方法指定如何把一个表划分成称为分区的片段。被划分的表被称作<em>分区表</em>。</p>
<p>表分区是解决一些因单表过大引用的性能问题的方式，比如某张表过大就会造成查询变慢，可能分区是一种解决方案。一般建议当单表大小超过内存就可以考虑表分区了。</p>
<p>PostgreSQL表分区有两种实现方式，声明式分区和表继承。它们各自有优缺点，比如，对声明式分区来说，分区必须具有和分区表正好相同的列集合，而在表继承中，子表可以有父表中没有出现过的额外列。除此之外，声明式分区也有着优秀的特点，可以减轻对分区表的维护代价、提供了操作的便捷性和查询性能，使用表继承将要做更多的工作才能达到同样的效果。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><h3 id="默认分区"><a href="#默认分区" class="headerlink" title="默认分区"></a>默认分区</h3><p>PosgtreSQL 11开始，支持为声明式分区表创建一个默认（DEFAULT）的分区，用于存储无法匹配其他任何分区的数据。只有 RANGE 分区表和 LIST 分区表需要默认分区。创建默认分区时使用 DEFAULT 子句替代 FOR VALUES 子句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table(</span><br><span class="line">    epoch <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    data text</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (epoch);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_1_100 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (MINVALUE) <span class="keyword">TO</span> (<span class="number">101</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_101_200 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">101</span>) <span class="keyword">TO</span> (<span class="number">201</span>);</span><br><span class="line"><span class="comment">-- 创建默认分区时使用 DEFAULT 子句替代 FOR VALUES 子句。</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_default <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table <span class="keyword">DEFAULT</span> ;</span><br></pre></td></tr></table></figure>
<p>如果没有创建默认分区，在插入<code>epoch</code>=201时，会报错，提示插入错误。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- [23514] 错误: 没有为行找到关系&quot;example_table&quot;的分区</span></span><br><span class="line"><span class="comment">-- 详细：失败行的分区键包含(epoch) = (201).</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table(epoch, data) <span class="keyword">VALUES</span> (<span class="number">201</span>, <span class="string">&#x27;good&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>默认分区存在以下限制：</p>
<ul>
<li>一个分区表只能拥有<strong>一个</strong> DEFAULT 分区；</li>
<li>对于已经存储在 DEFAULT 分区中的数据，不能再创建相应的分区；参见下文示例；</li>
<li>如果将已有的表挂载为 DEFAULT 分区，将会检查该表中的所有数据；如果在已有的分区中存在相同的数据，将会产生一个错误；</li>
<li>哈希分区表不支持 DEFAULT 分区，实际上也不需要支持。</li>
</ul>
<p>以列表分区为例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_list(</span><br><span class="line">    miner <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    epoch <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    data <span class="type">varchar</span>(<span class="number">50</span>)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> LIST (miner);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_list_02438 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table_list <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;f02438&#x27;</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_list_025002_025005 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table_list <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;f025002&#x27;</span>, <span class="string">&#x27;f025005&#x27;</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_list_default <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table_list <span class="keyword">DEFAULT</span> ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table_list <span class="keyword">VALUES</span> (<span class="string">&#x27;f03721&#x27;</span>, <span class="number">98</span>, <span class="string">&#x27;Green&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>如果此时未创建对<code>f03721</code>的分区表，上面的语句会插入到<code>example_table_list_default</code>表内。如果此时开始创建</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_list_03721 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table_list <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;f03721&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>操作将会失败。因为添加新的分区需要修改默认分区的范围。但是默认分区中已经存在<code>f02731</code>的分区数据项。</p>
<blockquote>
<p>错误: 某些行将违反默认分区”example_table_list_default”的更新分区约束</p>
</blockquote>
<p>为了解决这个问题，可以先将默认分区从分区表中卸载（<strong>DETACH PARTITION</strong>），创建新的分区，将默认分区中的相应的数据移动到新的分区，最后重新挂载默认分区。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 临时卸载默认分区</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> example_table_list DETACH <span class="keyword">PARTITION</span> example_table_list_default;</span><br><span class="line"><span class="comment">-- 创建一个新的列表分区表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_list_03721 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table_list <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;f03721&#x27;</span>);</span><br><span class="line"><span class="comment">-- 查询默认分区表内的对应数据并插入到新分区表内</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table_list_03721</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> example_table_list_default <span class="keyword">WHERE</span> miner <span class="operator">=</span> <span class="string">&#x27;f03721&#x27;</span>;</span><br><span class="line"><span class="comment">-- 删除默认分区表内的数据</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> example_table_list_default <span class="keyword">WHERE</span> miner <span class="operator">=</span> <span class="string">&#x27;f03721&#x27;</span>;</span><br><span class="line"><span class="comment">-- 重新挂载默认分区表</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> example_table_list ATTACH <span class="keyword">PARTITION</span> example_table_list_default <span class="keyword">DEFAULT</span> ;</span><br></pre></td></tr></table></figure>
<h3 id="分区自动索引"><a href="#分区自动索引" class="headerlink" title="分区自动索引"></a>分区自动索引</h3><p>在 PostgreSQL10 中，分区上的索引需要基于各个分区手动创建，而不能基于分区的父表创建索引。PostgreSQL 11 及以后的版本，声明式分区表可以基于分区表创建索引。分区表上的索引并不会创建一个物理上的索引，而是为每个分区上的索引创建一个模板。表继承方式的分区表需要为每一张分区表创建索引和约束。</p>
<p>如果在声明式分区表上创建了一个索引，PostgreSQL 自动为每个分区创建具有相同属性的索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在主表上创建索引，会在分表上自动创建对应的索引。</span></span><br><span class="line"><span class="comment">-- 在创建新的分区表时，也会自动创建好对应的索引。</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX example_table_epoch <span class="keyword">ON</span> example_table(epoch <span class="keyword">DESC</span>);</span><br><span class="line"><span class="comment">-- 在主表上执行删除索引时，也会自动在分区表上删除对应的索引。</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX example_table_epoch;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>自动创建的索引，名称按照 “{partition name}<em>{column name}_idx” 的模式定义。多个字段的复合索引使用下划线（</em>）连接字段名称。如果索引名称已经存在，在名称的最后添加一个数字。如果名称过长，使用缩写。</p>
</li>
<li><p>随后新增的分区或者通过 ATTACH PARTITION 挂载的分区都会自动创建相应的索引。</p>
</li>
<li><p>自动创建的索引不能单独删除，可以通过分区表统一删除。</p>
</li>
</ul>
<h3 id="跨分区移动数据"><a href="#跨分区移动数据" class="headerlink" title="跨分区移动数据"></a>跨分区移动数据</h3><p>在 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=PostgreSQL&amp;spm=1001.2101.3001.7020">PostgreSQL</a> 10 中，声明式分区表如果 UPDATE 语句修改了分区字段的值，导致数据需要移动到其他分区时，语句将会失败。PostgreSQL 11+ 以后能够正确处理更新分区字段的操作。根据<a target="_blank" rel="noopener" href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=2f178441044be">提交记录</a>，这种 UPDATE 语句实际上分为两步执行：从旧的分区中 <code>DELETE</code>相应记录，在新的分区中 <code>INSERT</code>相应记录。另外，跨分区移动数据的 UPDATE 语句将会导致触发器的执行顺序更加复杂。</p>
<h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><p>分区表有下列限制：</p>
<ul>
<li>没有办法创建跨越所有分区的排除约束，只可能单个约束每个叶子分区。</li>
<li>分区表上的惟一约束（也就是主键）必须包括所有分区键列。存在此限制是因为PostgreSQL只能每个分区中分别强制实施唯一性。</li>
<li><code>BEFORE ROW</code> 触发器无法更改哪个分区是新行的最终目标。</li>
<li>不允许在同一个分区树中混杂临时关系和持久关系。因此，如果分区表是持久的，则其分区也必须是持久的，反之亦然。在使用临时关系时，分区数的所有成员都必须来自于同一个会话。</li>
</ul>
<h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><p>厘清执行流程有助于从宏观上理解在哪个步骤中适合实现自动创建分区表。从数据库提供的机制上，有存储过程和触发器两种武器，分别可以实现在不同阶段处理不同拦截逻辑。</p>
<p>对于声明式分区表，所有被插入的行将被基于分区键的值，路由到<em>分区</em>中。每个分区都有一个由其<em>分区边界</em>定义的数据子集。当前支持的分区方法是范围、列表以及哈希。也就是说分区表的插入/更新操作，又一个内置的路由规则。</p>
<p>根据定义，结合对表的插入/更新操作以及触发器流程，一条数据在插入到分区表时，将经历以下步骤：</p>
<ol>
<li>触发分区主表的statement before insert</li>
<li>自动路由到符合范围的分区子表</li>
<li>触发符合范围的分区子表row before insert</li>
<li>数据插入</li>
<li>触发符合范围的分区子表row after insert</li>
<li>触发分区主表的statement after insert</li>
</ol>
<p>下面验证一下上述流程。</p>
<h3 id="触发器行为"><a href="#触发器行为" class="headerlink" title="触发器行为"></a>触发器行为</h3><h4 id="创建分区表"><a href="#创建分区表" class="headerlink" title="创建分区表"></a><strong>创建分区表</strong></h4><p>举个例子，创建一张测试分区表，并创建三个分区，<strong>不创建</strong>默认分区。由于默认分区的限制，对于已经存储在 DEFAULT 分区中的数据，不能再创建相应的分区，需要先DETACH默认分区手动做数据转移，然后才可以创建新范围分区，这个步骤无法实现自动创建。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> example_table CASCADE ;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table(col1 <span class="type">INT</span>) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (col1);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_1 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">0</span>) <span class="keyword">TO</span> (<span class="number">10</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_2 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">11</span>) <span class="keyword">TO</span> (<span class="number">20</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_3 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">21</span>) <span class="keyword">TO</span> (<span class="number">30</span>);</span><br></pre></td></tr></table></figure>
<h4 id="创建触发器函数"><a href="#创建触发器函数" class="headerlink" title="创建触发器函数"></a><strong>创建触发器函数</strong></h4><p>创建一个用于观察触发器触发阶段的函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> notice_trigger() <span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span> <span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    RAISE NOTICE <span class="string">&#x27;trigger name:%; table_name:%; level:%; op:%; when:%; value:%&#x27;</span>,</span><br><span class="line">        tg_name, tg_table_name, tg_level, tg_op, tg_when, <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">new</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<h4 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a><strong>创建触发器</strong></h4><p>在分区表主表<code>example_table</code>上绑定测试分区表INSERT和UPDATE触发器，分别是语句级别和行级别，与before 和after的组合。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> show_notice_before_insert_stmt</span><br><span class="line">    BEFORE <span class="keyword">INSERT</span></span><br><span class="line">    <span class="keyword">ON</span> example_table</span><br><span class="line">    <span class="keyword">FOR</span> STATEMENT</span><br><span class="line"><span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger();</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> show_notice_after_insert_stmt</span><br><span class="line">    AFTER <span class="keyword">INSERT</span></span><br><span class="line">    <span class="keyword">ON</span> example_table</span><br><span class="line">    <span class="keyword">FOR</span> STATEMENT</span><br><span class="line"><span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger();</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> show_notice_before_insert_row</span><br><span class="line">    BEFORE <span class="keyword">INSERT</span></span><br><span class="line">    <span class="keyword">ON</span> example_table</span><br><span class="line">    <span class="keyword">FOR</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger();</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> show_notice_after_insert_row</span><br><span class="line">    AFTER <span class="keyword">INSERT</span></span><br><span class="line">    <span class="keyword">ON</span> example_table</span><br><span class="line">    <span class="keyword">FOR</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger();</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> show_notice_before_update_stmt</span><br><span class="line">    BEFORE <span class="keyword">UPDATE</span></span><br><span class="line">    <span class="keyword">ON</span> example_table</span><br><span class="line">    <span class="keyword">FOR</span> STATEMENT</span><br><span class="line"><span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger();</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> show_notice_after_update_stmt</span><br><span class="line">    AFTER <span class="keyword">UPDATE</span></span><br><span class="line">    <span class="keyword">ON</span> example_table</span><br><span class="line">    <span class="keyword">FOR</span> STATEMENT</span><br><span class="line"><span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger();</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> show_notice_before_update_row</span><br><span class="line">    BEFORE <span class="keyword">UPDATE</span></span><br><span class="line">    <span class="keyword">ON</span> example_table</span><br><span class="line">    <span class="keyword">FOR</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger();</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> show_notice_after_update_row</span><br><span class="line">    AFTER <span class="keyword">UPDATE</span></span><br><span class="line">    <span class="keyword">ON</span> example_table</span><br><span class="line">    <span class="keyword">FOR</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger();</span><br></pre></td></tr></table></figure>
<p>通过观察表结构定义我们可以看到，主表上创建出8个触发器。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">example<span class="operator">=</span># \d<span class="operator">+</span> example_table</span><br><span class="line">                         Partitioned <span class="keyword">table</span> &quot;public.example_table&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Storage <span class="operator">|</span> Stats target <span class="operator">|</span> Description</span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------+---------+--------------+-------------</span></span><br><span class="line"> col1   <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> plain   <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"><span class="keyword">Partition</span> key: <span class="keyword">RANGE</span> (col1)</span><br><span class="line">Triggers:</span><br><span class="line">    show_notice_after_insert_row AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> example_table <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger()</span><br><span class="line">    show_notice_after_insert_stmt AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> example_table <span class="keyword">FOR</span> <span class="keyword">EACH</span> STATEMENT <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger()</span><br><span class="line">    show_notice_after_update_row AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> example_table <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger()</span><br><span class="line">    show_notice_after_update_stmt AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> example_table <span class="keyword">FOR</span> <span class="keyword">EACH</span> STATEMENT <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger()</span><br><span class="line">    show_notice_before_insert_row BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> example_table <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger()</span><br><span class="line">    show_notice_before_insert_stmt BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> example_table <span class="keyword">FOR</span> <span class="keyword">EACH</span> STATEMENT <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger()</span><br><span class="line">    show_notice_before_update_row BEFORE <span class="keyword">UPDATE</span> <span class="keyword">ON</span> example_table <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger()</span><br><span class="line">    show_notice_before_update_stmt BEFORE <span class="keyword">UPDATE</span> <span class="keyword">ON</span> example_table <span class="keyword">FOR</span> <span class="keyword">EACH</span> STATEMENT <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger()</span><br><span class="line">Partitions: example_table_1 <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">0</span>) <span class="keyword">TO</span> (<span class="number">10</span>),</span><br><span class="line">            example_table_2 <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">11</span>) <span class="keyword">TO</span> (<span class="number">20</span>),</span><br><span class="line">            example_table_3 <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">21</span>) <span class="keyword">TO</span> (<span class="number">30</span>)</span><br></pre></td></tr></table></figure>
<p>分区表上也自动创建出了4个行级触发器。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">example<span class="operator">=</span># \d example_table_1</span><br><span class="line">          <span class="keyword">Table</span> &quot;public.example_table_1&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> col1   <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="keyword">Partition</span> <span class="keyword">of</span>: example_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">0</span>) <span class="keyword">TO</span> (<span class="number">10</span>)</span><br><span class="line">Triggers:</span><br><span class="line">    show_notice_after_insert_row AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> example_table_1 <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger(), <span class="keyword">ON</span> <span class="keyword">TABLE</span> example_table</span><br><span class="line">    show_notice_after_update_row AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> example_table_1 <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger(), <span class="keyword">ON</span> <span class="keyword">TABLE</span> example_table</span><br><span class="line">    show_notice_before_insert_row BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> example_table_1 <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger(), <span class="keyword">ON</span> <span class="keyword">TABLE</span> example_table</span><br><span class="line">    show_notice_before_update_row BEFORE <span class="keyword">UPDATE</span> <span class="keyword">ON</span> example_table_1 <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> notice_trigger(), <span class="keyword">ON</span> <span class="keyword">TABLE</span> example_table</span><br></pre></td></tr></table></figure>
<p>分区表主表类型为（partitioned table)，分区表类型为（table）。</p>
<ul>
<li>在主表上创建触发器，会为每一个子表创建触发器。</li>
<li><code>FOR EACH STATEMENT</code> 只会在主表上创建</li>
<li><code>FOR EACH ROW</code> 才会为每一个子表创建（如下查询结果）。</li>
</ul>
<h4 id="插入一条数据"><a href="#插入一条数据" class="headerlink" title="插入一条数据"></a><strong>插入一条数据</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table <span class="keyword">VALUES</span> (<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Output</span></span><br><span class="line">[<span class="number">00000</span>] <span class="keyword">trigger</span> name:show_notice_before_insert_stmt; table_name:example_table; level:STATEMENT; op:<span class="keyword">INSERT</span>; <span class="keyword">when</span>:BEFORE; <span class="keyword">value</span>:<span class="operator">&lt;</span><span class="keyword">NULL</span><span class="operator">&gt;</span></span><br><span class="line">[<span class="number">00000</span>] <span class="keyword">trigger</span> name:show_notice_before_insert_row; table_name:example_table_1; level:<span class="type">ROW</span>; op:<span class="keyword">INSERT</span>; <span class="keyword">when</span>:BEFORE; <span class="keyword">value</span>:(<span class="number">3</span>)</span><br><span class="line">[<span class="number">00000</span>] <span class="keyword">trigger</span> name:show_notice_after_insert_row; table_name:example_table_1; level:<span class="type">ROW</span>; op:<span class="keyword">INSERT</span>; <span class="keyword">when</span>:AFTER; <span class="keyword">value</span>:(<span class="number">3</span>)</span><br><span class="line">[<span class="number">00000</span>] <span class="keyword">trigger</span> name:show_notice_after_insert_stmt; table_name:example_table; level:STATEMENT; op:<span class="keyword">INSERT</span>; <span class="keyword">when</span>:AFTER; <span class="keyword">value</span>:<span class="operator">&lt;</span><span class="keyword">NULL</span><span class="operator">&gt;</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> affected <span class="keyword">in</span> <span class="number">60</span> ms</span><br></pre></td></tr></table></figure>
<p>分区表INSERT触发器的执行顺序：</p>
<ol>
<li>主表<code>example_table</code> statement 级别 INSERT BEFOER触发器</li>
<li>主表<code>example_table</code> statement 级别 INSERT AFTER 触发器</li>
<li>分区表<code>example_table_1</code> 行级别 INSERT BEFORE 触发器</li>
<li>分区表<code>example_table_1</code> 行级别 INSERT AFTER 触发器</li>
</ol>
<h4 id="插入不存在分区的数据"><a href="#插入不存在分区的数据" class="headerlink" title="插入不存在分区的数据"></a><strong>插入不存在分区的数据</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table <span class="keyword">VALUES</span> (<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Output</span></span><br><span class="line">[<span class="number">23514</span>] 错误: 没有为行找到关系&quot;example_table&quot;的分区</span><br><span class="line">详细：失败行的分区键包含(col1) <span class="operator">=</span> (<span class="number">32</span>).</span><br><span class="line">[<span class="number">00000</span>] <span class="keyword">trigger</span> name:show_notice_before_insert_stmt; table_name:example_table; level:STATEMENT; op:<span class="keyword">INSERT</span>; <span class="keyword">when</span>:BEFORE; <span class="keyword">value</span>:<span class="operator">&lt;</span><span class="keyword">NULL</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>插入一条不存在分区的数据时，会导致插入错误，提示没找到分区。分区表INSERT触发器的执行顺序：</p>
<ol>
<li>主表<code>example_table</code> statement 级别 INSERT BEFORE 触发器</li>
<li>主表<code>example_table</code> statement 级别 INSERT AFTER 触发器</li>
</ol>
<h4 id="修改触发器函数"><a href="#修改触发器函数" class="headerlink" title="修改触发器函数"></a>修改触发器函数</h4><p>修改触发器函数<code>notice_trigger</code>使它拥有创建表的能力。以下代码仅供测试，认为新插入数据时为不存在分区范围的数据，且分区列数值在31-40之间。并定义触发器在行级、插入前触发。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> notice_trigger() <span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span> <span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    RAISE NOTICE <span class="string">&#x27;trigger name:%; table_name:%; level:%; op:%; when:%; value:%&#x27;</span>,</span><br><span class="line">        tg_name, tg_table_name, tg_level, tg_op, tg_when, <span class="keyword">new</span>;</span><br><span class="line">    IF tg_level <span class="operator">=</span> <span class="string">&#x27;ROW&#x27;</span> <span class="keyword">AND</span> tg_op <span class="operator">=</span> <span class="string">&#x27;INSERT&#x27;</span> <span class="keyword">AND</span> tg_when <span class="operator">=</span> <span class="string">&#x27;BEFORE&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_4 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">31</span>) <span class="keyword">TO</span> (<span class="number">40</span>);</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table_4 <span class="keyword">SELECT</span> new.<span class="operator">*</span>;</span><br><span class="line">        <span class="keyword">RETURN</span> <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">new</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<p>再次执行数据插入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table <span class="keyword">VALUES</span> (<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Output</span></span><br><span class="line">[<span class="number">23514</span>] 错误: 没有为行找到关系&quot;example_table&quot;的分区</span><br><span class="line">详细：失败行的分区键包含(col1) <span class="operator">=</span> (<span class="number">32</span>).</span><br><span class="line">[<span class="number">00000</span>] <span class="keyword">trigger</span> name:show_notice_before_insert_stmt; table_name:example_table; level:STATEMENT; op:<span class="keyword">INSERT</span>; <span class="keyword">when</span>:BEFORE; <span class="keyword">value</span>:<span class="operator">&lt;</span><span class="keyword">NULL</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>主表上由于分区表的默认插入行为，并没有触发行级触发器，并由于自动路由，错误提示找不到关系分区报错退出。</p>
<h4 id="再次修改触发器函数"><a href="#再次修改触发器函数" class="headerlink" title="再次修改触发器函数"></a><strong>再次修改触发器函数</strong></h4><p>这次计划通过语句级别INSERT BEFORE触发器来创建新分区表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> notice_trigger() <span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span> <span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    RAISE NOTICE <span class="string">&#x27;trigger name:%; table_name:%; level:%; op:%; when:%; value:%&#x27;</span>,</span><br><span class="line">        tg_name, tg_table_name, tg_level, tg_op, tg_when, <span class="keyword">new</span>;</span><br><span class="line">    IF tg_level <span class="operator">=</span> <span class="string">&#x27;STATEMENT&#x27;</span> <span class="keyword">AND</span> tg_op <span class="operator">=</span> <span class="string">&#x27;INSERT&#x27;</span> <span class="keyword">AND</span> tg_when <span class="operator">=</span> <span class="string">&#x27;BEFORE&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table_4 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> example_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">31</span>) <span class="keyword">TO</span> (<span class="number">40</span>);</span><br><span class="line">        <span class="keyword">RETURN</span> <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">new</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<p>再次尝试插入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table <span class="keyword">VALUES</span> (<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Output</span></span><br><span class="line">[<span class="number">55006</span>] 错误: 无法<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> .. <span class="keyword">PARTITION</span> <span class="keyword">OF</span> &quot;example_table&quot;  因为它正在被这个会话中的活动查询使用</span><br><span class="line">在位置：<span class="keyword">SQL</span> 语句 &quot;CREATE TABLE example_table_4 PARTITION OF example_table FOR VALUES FROM (31) TO (40)&quot;</span><br><span class="line">在<span class="keyword">SQL</span>语句的第<span class="number">6</span>行的PL<span class="operator">/</span>pgSQL函数notice_trigger()</span><br><span class="line">[<span class="number">00000</span>] <span class="keyword">trigger</span> name:show_notice_before_insert_stmt; table_name:example_table; level:STATEMENT; op:<span class="keyword">INSERT</span>; <span class="keyword">when</span>:BEFORE; <span class="keyword">value</span>:<span class="operator">&lt;</span><span class="keyword">NULL</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>从上得知，<strong><code>BEFORE ROW</code> 触发器无法更改哪个分区是新行的最终目标。</strong></p>
<h3 id="自动路由流程"><a href="#自动路由流程" class="headerlink" title="自动路由流程"></a>自动路由流程</h3><p>从以上动作得知：</p>
<ul>
<li>分区表主表只会触发语句级别的触发器</li>
<li>分区表只会触发行级触发器</li>
<li>数据库会对插入和更新动作自动做路由规则处理</li>
</ul>
<p><img src="../../public/images/分区表pg处理流程.png" alt="自动路由处理流程"></p>
<p>整个插入过程在一个事务内，在插入开始期间，会收集整个分区表信息；声明式分区表有一个内置的路由行为，该行为发生在语句级别before触发器之后。它会根据分区列将实际的INSERT/UPDATE动作定向到分区中进行插入和更新。此时主分区表不会触发它的行级触发器，而是触发分区表中的行级触发器，且不会触发分区表的语句级触发器。无法在语句级别动态创建新分区，到达自动路由阶段，对不存在分区的插入会导致插入失败，不再执行后续动作。</p>
<h1 id="规则系统"><a href="#规则系统" class="headerlink" title="规则系统"></a>规则系统</h1><p>考虑到高可维护性，简便易行和最大程度使用数据库的特点，最终考虑使用声明式分区来实现自动表分区。</p>
<p>既然无法使用触发器达到在插入数据时，自动创建不存在范围的分区表的行为，有没有办法不通过触发器，而通过数据库自身的特性达到同样的目的呢？</p>
<p>答案是有的。经过调研，PostgreSQL数据库支持重写规则（RULE）。</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [ <span class="keyword">OR</span> REPLACE ] RULE name <span class="keyword">AS</span> <span class="keyword">ON</span> event</span><br><span class="line">    <span class="keyword">TO</span> table_name [ <span class="keyword">WHERE</span> <span class="keyword">condition</span> ]</span><br><span class="line">    DO [ ALSO <span class="operator">|</span> INSTEAD ] &#123; NOTHING <span class="operator">|</span> command <span class="operator">|</span> ( command ; command ... ) &#125;</span><br><span class="line"></span><br><span class="line">其中 event 可以是以下之一：</span><br><span class="line"></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">|</span> <span class="keyword">INSERT</span> <span class="operator">|</span> <span class="keyword">UPDATE</span> <span class="operator">|</span> <span class="keyword">DELETE</span></span><br></pre></td></tr></table></figure>
<p>PostgreSQL规则系统允许我们定义   针对数据库表中插入、更新或者删除动作上的替代动作。大约来说，当在   一个给定表上执行给定命令时，一条规则会导致执行额外的命令。或者，   <code>INSTEAD</code>规则可以用另一个命令替换给定的命令，或者导致一个命令根本不被执行。</p>
<p>使用规则来改变插入的流程，绕开分区表触发器的执行顺序限制，直接插入到目标表内。</p>
<p>原理是使用规则重定向插入，将INSERT/UPDATE操作替换成用函数来插入。函数插入时判断是否报错了，如果报错，新增表。</p>
<h2 id="设计流程"><a href="#设计流程" class="headerlink" title="设计流程"></a>设计流程</h2><p>在分区表主表上创建两个规则，分别是INSERT和 UPDATE，替换数据库向主表默认插入和更新操作。此时的触发器和流程从下图左边变成了右边的流程，规则接管默认插入机制，在插入数据前做一层条件判断，达到自动创建分区的目的。由于规则系统仅支持INSERT/UPDATE/SELECT/DELETE操作，因此需要编写一个函数来托管整个过程。</p>
<p><img src="../../public/images/分区表pg处理流程2.png" alt="重写规则"></p>
<p>在这个大框架下还需要解决自动化创建表时一致性行为，以及接管一些数据库默认插入/更新时的功能：</p>
<ul>
<li>表分区名称约定</li>
<li>结合Filecoin业务，比如根据区块高度对数据分区，对高度计算得到分区表后缀</li>
<li>获取分区表名称是否存在</li>
<li>唯一键冲突</li>
<li>分区移动</li>
</ul>
<h1 id="函数-存储过程"><a href="#函数-存储过程" class="headerlink" title="函数(存储过程)"></a>函数(存储过程)</h1><h2 id="表分区名称约定"><a href="#表分区名称约定" class="headerlink" title="表分区名称约定"></a>表分区名称约定</h2><h3 id="表名称约定"><a href="#表名称约定" class="headerlink" title="表名称约定"></a>表名称约定</h3><p>通常，对表的数据进行分区，对数据行记录时间进行划分。以此为基础便于以时间范围查询，因此分区表将设置成主表+后缀名的方式命名。后缀名定义以下4种按时间划分的分区规则：</p>
<ol>
<li>按天分区 (分区表命名规则：<code>table_name_2022_02_18_1560240_1563119</code>)</li>
<li>按周分区 (分区表命名规则：<code>table_name_2022_w7_1548720_1568879</code>)</li>
<li>按月分区 (分区表命名规则：<code>table_name_2022_02_1560240_1563119</code>)</li>
<li>按年分区 (分区表命名规则：<code>table_name_2022_1560240_1563119</code>)</li>
</ol>
<p>以上分区规则统一按照北京时间为基准，以一天的零点作为开始，23点59分59秒作为结束。</p>
<p><strong>按天分区</strong></p>
<p>分区表命名规则为 <code>主表</code>_<code>年</code>_<code>月</code>_<code>日</code>_<code>起始epoch</code>_<code>终止epoch</code></p>
<p>其中月份为两位数，不足两位前缀补0。</p>
<p><strong>按周分区</strong></p>
<p>分区表命名规则为 <code>主表</code>_<code>年</code>_<code>w全年周数</code>_<code>起始epoch</code>_<code>终止epoch</code></p>
<p><strong>按月分区</strong></p>
<p>分区表命名规则为 <code>主表</code>_<code>年</code>_<code>月</code>_<code>起始epoch</code>_<code>终止epoch</code></p>
<p>其中月份为两位数，不足两位前缀补0。</p>
<p><strong>按年分区</strong></p>
<p>分区表命名规则为 <code>主表</code>_<code>年</code>_<code>起始epoch</code>_<code>终止epoch</code></p>
<p><strong>以下内容为实现分区表命名规则而设立的函数，执行函数可以计算得到上述规则后缀和分区范围。</strong></p>
<h3 id="分区范围类型定义"><a href="#分区范围类型定义" class="headerlink" title="分区范围类型定义"></a>分区范围类型定义</h3><p>定义数据库的类型，拥有以下6个字段：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> TYPE IF <span class="keyword">EXISTS</span> PARTITION_TABLE_RANGE_DEFINITION CASCADE ;</span><br><span class="line"><span class="comment">-- 创建统一的分区规则类型，定义后缀字段、触发查询时的日期、</span></span><br><span class="line"><span class="comment">-- 分区的起始时间(起始epoch)和终止时间(终止epoch)</span></span><br><span class="line"><span class="comment">-- 终止epoch与终止时间不是一一对应，终止epoch通常是23:59:30。链的高度每30秒变更一次。</span></span><br><span class="line"><span class="keyword">CREATE</span> TYPE PARTITION_TABLE_RANGE_DEFINITION <span class="keyword">AS</span></span><br><span class="line">(</span><br><span class="line">    suffix      <span class="type">VARCHAR</span>,</span><br><span class="line">    hit_date    <span class="type">DATE</span>,</span><br><span class="line">    begin_epoch <span class="type">BIGINT</span>,</span><br><span class="line">    begin_time  TIMESTAMPTZ,</span><br><span class="line">    end_epoch   <span class="type">BIGINT</span>,</span><br><span class="line">    end_time    TIMESTAMPTZ</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>分区范围字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>suffix</td>
<td>分区表的后缀名称，配合主表名+后缀定义出分区表名称</td>
</tr>
<tr>
<td>hit_date</td>
<td>查询分区范围定义的日期</td>
</tr>
<tr>
<td>begin_epoch</td>
<td>分区表开始高度（Filecoin epoch， 下同)</td>
</tr>
<tr>
<td>begin_time</td>
<td>分区表开始时间（参考，分区以begin_epoch为主，下同）</td>
</tr>
<tr>
<td>end_epoch</td>
<td>分区表结束高度</td>
</tr>
<tr>
<td>end_time</td>
<td>分区表结束时间</td>
</tr>
</tbody>
</table>
</div>
<h3 id="分区范围实现"><a href="#分区范围实现" class="headerlink" title="分区范围实现"></a>分区范围实现</h3><p>注意！分区表<code>FROM (MINVALUE) TO (101)</code> 是前闭后开。也就是插入的分区列应满足 epoch ∈[MINVALUE, 101)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_part_table(col1 <span class="type">INT</span>) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (col1);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_part_table_1 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> test_part_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">0</span>) <span class="keyword">TO</span> (<span class="number">10</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_part_table_2 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> test_part_table <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">10</span>) <span class="keyword">TO</span> (<span class="number">20</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_part_table <span class="keyword">SELECT</span> i <span class="keyword">FROM</span> generate_series(<span class="number">0</span>, <span class="number">10</span>) g(i);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入到 test_part_table_1 的值 从 0-9；</span></span><br><span class="line"><span class="comment">-- 插入到 test_part_table_2 的值 为10.</span></span><br></pre></td></tr></table></figure>
<h4 id="按天分区"><a href="#按天分区" class="headerlink" title="按天分区"></a>按天分区</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按日分区，返回的分区表的表后缀规则为 &#x27;年_月_日&#x27;_开始epoch_结束epoch </span></span><br><span class="line"><span class="comment">-- (例如：table_name_2022_02_18_1560240_1563119)</span></span><br><span class="line"><span class="comment">-- 时间范围 一天的的00:00:00 ~ 一天的23:59:59</span></span><br><span class="line"><span class="comment">-- 高度范围 一天日期的00:00:00 ~ 一天日期的23:59:30</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> calc_partition_range_by_day(current_ts TIMESTAMPTZ <span class="operator">=</span> <span class="built_in">current_timestamp</span>)</span><br><span class="line">    <span class="keyword">RETURNS</span> SETOF PARTITION_TABLE_RANGE_DEFINITION</span><br><span class="line">    IMMUTABLE STRICT</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    startup_time timestamptz <span class="operator">=</span> <span class="string">&#x27;2020-08-25T06:00:00+08:00&#x27;</span>::timestamptz;</span><br><span class="line">    &quot;year&quot;       <span class="type">INT</span>         <span class="operator">=</span> <span class="built_in">extract</span>(<span class="keyword">YEAR</span> <span class="keyword">FROM</span> current_ts);</span><br><span class="line">    &quot;month&quot;      <span class="type">INT</span>         <span class="operator">=</span> <span class="built_in">extract</span>(MONTHS <span class="keyword">FROM</span> current_ts);</span><br><span class="line">    &quot;day&quot;        <span class="type">INT</span>         <span class="operator">=</span> <span class="built_in">extract</span>(<span class="keyword">DAY</span> <span class="keyword">FROM</span> current_ts);</span><br><span class="line">    begin_time   TIMESTAMPTZ <span class="operator">=</span> date_trunc(<span class="string">&#x27;day&#x27;</span>, current_ts);</span><br><span class="line">    begin_epoch  <span class="type">BIGINT</span>      <span class="operator">=</span> calc_epoch_by_ts(begin_time);</span><br><span class="line">    day_interval <span class="type">INTERVAL</span>    <span class="operator">=</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1 DAY&#x27;</span> <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1 SECOND&#x27;</span>;</span><br><span class="line">    end_time     TIMESTAMPTZ <span class="operator">=</span> begin_time <span class="operator">+</span> day_interval;</span><br><span class="line">    end_epoch    <span class="type">BIGINT</span>      <span class="operator">=</span> calc_epoch_by_ts(end_time <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1 SECOND&#x27;</span>);</span><br><span class="line">    mm_month     <span class="type">VARCHAR</span>     <span class="operator">=</span> (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> &quot;month&quot; <span class="operator">&lt;</span> <span class="number">10</span> <span class="keyword">THEN</span> <span class="string">&#x27;0&#x27;</span> <span class="operator">||</span> &quot;month&quot; <span class="keyword">ELSE</span> <span class="string">&#x27;&#x27;</span> <span class="operator">||</span> &quot;month&quot; <span class="keyword">END</span>);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">--     考虑边界条件，当计算得出的起始高度小于0，说明时间已经小于主网上线时间。</span></span><br><span class="line">    IF begin_epoch <span class="operator">&lt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        begin_time <span class="operator">=</span> startup_time;</span><br><span class="line">        begin_epoch <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        &quot;year&quot; <span class="operator">=</span> <span class="built_in">extract</span>(<span class="keyword">YEAR</span> <span class="keyword">FROM</span> begin_time);</span><br><span class="line">        &quot;month&quot; <span class="operator">=</span> <span class="built_in">extract</span>(MONTHS <span class="keyword">FROM</span> begin_time);</span><br><span class="line">        &quot;day&quot; <span class="operator">=</span> <span class="built_in">extract</span>(<span class="keyword">DAY</span> <span class="keyword">FROM</span> begin_time);</span><br><span class="line">        end_time <span class="operator">=</span> date_trunc(<span class="string">&#x27;day&#x27;</span>, begin_time) <span class="operator">+</span> day_interval;</span><br><span class="line">        end_epoch <span class="operator">=</span> calc_epoch_by_ts(end_time <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1 SECOND&#x27;</span>);</span><br><span class="line">        mm_month <span class="operator">=</span> (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> &quot;month&quot; <span class="operator">&lt;</span> <span class="number">10</span> <span class="keyword">THEN</span> <span class="string">&#x27;0&#x27;</span> <span class="operator">||</span> &quot;month&quot; <span class="keyword">ELSE</span> <span class="string">&#x27;&#x27;</span> <span class="operator">||</span> &quot;month&quot; <span class="keyword">END</span>);</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    RAISE NOTICE <span class="string">&#x27;[calc_partition_range_by_day]current_ts: %&#x27;</span>, current_ts;</span><br><span class="line">    <span class="keyword">RETURN</span> QUERY <span class="keyword">SELECT</span> concat_ws(<span class="string">&#x27;_&#x27;</span>, &quot;year&quot;, mm_month, &quot;day&quot;, begin_epoch, end_epoch)::<span class="type">VARCHAR</span>,</span><br><span class="line">                        current_ts::<span class="type">DATE</span>,</span><br><span class="line">                        begin_epoch,</span><br><span class="line">                        begin_time,</span><br><span class="line">                        end_epoch,</span><br><span class="line">                        end_time;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<h4 id="按周分区"><a href="#按周分区" class="headerlink" title="按周分区"></a>按周分区</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按周分区，返回的分区表的表后缀规则为 &#x27;年份&#x27;_w&#x27;第n周&#x27;_开始epoch_结束epoch </span></span><br><span class="line"><span class="comment">-- (例如：table_name_2022_w7_1548720_1568879)</span></span><br><span class="line"><span class="comment">-- 时间范围 周一的00:00:00 ~ 周日的23:59:59</span></span><br><span class="line"><span class="comment">-- 高度范围 周一日期的00:00:00 ~ 周日的23:59:30</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> calc_partition_range_by_week_of_year(current_ts TIMESTAMPTZ <span class="operator">=</span> <span class="built_in">current_timestamp</span>)</span><br><span class="line">    <span class="keyword">RETURNS</span> SETOF PARTITION_TABLE_RANGE_DEFINITION</span><br><span class="line">    IMMUTABLE STRICT</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    startup_time timestamptz <span class="operator">=</span> <span class="string">&#x27;2020-08-25T06:00:00+08:00&#x27;</span>::timestamptz;</span><br><span class="line">    week_of_year  <span class="type">INT</span>         <span class="operator">=</span> <span class="built_in">extract</span>(WEEK <span class="keyword">FROM</span> current_ts);</span><br><span class="line">    iso_year      <span class="type">INT</span>         <span class="operator">=</span> <span class="built_in">extract</span>(ISOYEAR <span class="keyword">FROM</span> current_ts);</span><br><span class="line">    begin_of_week TIMESTAMPTZ <span class="operator">=</span> date_trunc(<span class="string">&#x27;WEEK&#x27;</span>, current_ts);</span><br><span class="line">    begin_epoch   <span class="type">BIGINT</span>      <span class="operator">=</span> calc_epoch_by_ts(begin_of_week);</span><br><span class="line">    week_interval <span class="type">INTERVAL</span>    <span class="operator">=</span> <span class="type">INTERVAL</span> <span class="string">&#x27;7 DAYS&#x27;</span>;</span><br><span class="line">    end_of_week   TIMESTAMPTZ <span class="operator">=</span> begin_of_week <span class="operator">+</span> week_interval;</span><br><span class="line">    end_epoch     <span class="type">BIGINT</span>      <span class="operator">=</span> calc_epoch_by_ts(end_of_week);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">--     考虑边界条件，当计算得出的起始高度小于0，说明时间已经小于主网上线时间。</span></span><br><span class="line">    IF begin_epoch <span class="operator">&lt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        begin_of_week <span class="operator">=</span> startup_time;</span><br><span class="line">        begin_epoch <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        week_of_year <span class="operator">=</span> <span class="built_in">extract</span>(WEEK <span class="keyword">FROM</span> begin_of_week);</span><br><span class="line">        iso_year <span class="operator">=</span> <span class="built_in">extract</span>(ISOYEAR <span class="keyword">FROM</span> begin_of_week);</span><br><span class="line">        end_of_week <span class="operator">=</span> date_trunc(<span class="string">&#x27;WEEK&#x27;</span>, begin_of_week) <span class="operator">+</span> week_interval;</span><br><span class="line">        end_epoch <span class="operator">=</span> calc_epoch_by_ts(end_of_week);</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">RETURN</span> QUERY <span class="keyword">SELECT</span> (concat_ws(<span class="string">&#x27;_&#x27;</span>, iso_year, concat(<span class="string">&#x27;w&#x27;</span>, week_of_year), begin_epoch, end_epoch))::<span class="type">VARCHAR</span>,</span><br><span class="line">                        current_ts::<span class="type">DATE</span>,</span><br><span class="line">                        begin_epoch,</span><br><span class="line">                        begin_of_week,</span><br><span class="line">                        end_epoch,</span><br><span class="line">                        end_of_week;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<h4 id="按月分区"><a href="#按月分区" class="headerlink" title="按月分区"></a>按月分区</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按月分区，返回的分区表的表后缀规则为 &#x27;年_月&#x27;_开始epoch_结束epoch </span></span><br><span class="line"><span class="comment">-- (例如：table_name_2022_02_1560240_1563119)</span></span><br><span class="line"><span class="comment">-- 时间范围 每个月的第一天的的00:00:00 ~ 每个月的最后一天的23:59:59</span></span><br><span class="line"><span class="comment">-- 高度范围 每个月的第一天日期的00:00:00 ~ 每个月的最后一天日期的23:59:30</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> calc_partition_range_by_month(current_ts TIMESTAMPTZ <span class="operator">=</span> <span class="built_in">current_timestamp</span>)</span><br><span class="line">    <span class="keyword">RETURNS</span> SETOF PARTITION_TABLE_RANGE_DEFINITION</span><br><span class="line">    IMMUTABLE STRICT</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    startup_time timestamptz <span class="operator">=</span> <span class="string">&#x27;2020-08-25T06:00:00+08:00&#x27;</span>::timestamptz;</span><br><span class="line">    begin_time     TIMESTAMPTZ <span class="operator">=</span> date_trunc(<span class="string">&#x27;month&#x27;</span>, current_ts);</span><br><span class="line">    &quot;year&quot;         <span class="type">INT</span>         <span class="operator">=</span> <span class="built_in">extract</span>(<span class="keyword">YEAR</span> <span class="keyword">FROM</span> begin_time);</span><br><span class="line">    &quot;month&quot;        <span class="type">INT</span>         <span class="operator">=</span> <span class="built_in">extract</span>(MONTHS <span class="keyword">FROM</span> begin_time);</span><br><span class="line">    begin_epoch    <span class="type">BIGINT</span>      <span class="operator">=</span> calc_epoch_by_ts(begin_time);</span><br><span class="line">    month_interval <span class="type">INTERVAL</span>    <span class="operator">=</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1 month&#x27;</span>;</span><br><span class="line">    end_time       TIMESTAMPTZ <span class="operator">=</span> begin_time <span class="operator">+</span> month_interval;</span><br><span class="line">    end_epoch      <span class="type">BIGINT</span>      <span class="operator">=</span> calc_epoch_by_ts(end_time);</span><br><span class="line">    mm_month       <span class="type">VARCHAR</span>     <span class="operator">=</span> (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> &quot;month&quot; <span class="operator">&lt;</span> <span class="number">10</span> <span class="keyword">THEN</span> <span class="string">&#x27;0&#x27;</span> <span class="operator">||</span> &quot;month&quot; <span class="keyword">ELSE</span> <span class="string">&#x27;&#x27;</span> <span class="operator">||</span> &quot;month&quot; <span class="keyword">END</span>);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">--     考虑边界条件，当计算得出的起始高度小于0，说明时间已经小于主网上线时间。</span></span><br><span class="line">    IF begin_epoch <span class="operator">&lt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        begin_time <span class="operator">=</span> startup_time;</span><br><span class="line">        begin_epoch <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        &quot;year&quot; <span class="operator">=</span> <span class="built_in">extract</span>(<span class="keyword">YEAR</span> <span class="keyword">FROM</span> begin_time);</span><br><span class="line">        &quot;month&quot; <span class="operator">=</span> <span class="built_in">extract</span>(MONTHS <span class="keyword">FROM</span> begin_time);</span><br><span class="line">        end_time <span class="operator">=</span> date_trunc(<span class="string">&#x27;month&#x27;</span>, begin_time) <span class="operator">+</span> month_interval;</span><br><span class="line">        end_epoch <span class="operator">=</span> calc_epoch_by_ts(end_time);</span><br><span class="line">        mm_month <span class="operator">=</span> (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> &quot;month&quot; <span class="operator">&lt;</span> <span class="number">10</span> <span class="keyword">THEN</span> <span class="string">&#x27;0&#x27;</span> <span class="operator">||</span> &quot;month&quot; <span class="keyword">ELSE</span> <span class="string">&#x27;&#x27;</span> <span class="operator">||</span> &quot;month&quot; <span class="keyword">END</span>)::<span class="type">varchar</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">RETURN</span> QUERY <span class="keyword">SELECT</span> (concat_ws(<span class="string">&#x27;_&#x27;</span>, &quot;year&quot;, mm_month, begin_epoch, end_epoch))::<span class="type">VARCHAR</span>,</span><br><span class="line">                        current_ts::<span class="type">DATE</span>,</span><br><span class="line">                        begin_epoch,</span><br><span class="line">                        begin_time,</span><br><span class="line">                        end_epoch,</span><br><span class="line">                        end_time;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<h4 id="按年分区"><a href="#按年分区" class="headerlink" title="按年分区"></a>按年分区</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按年分区，返回的分区表的表后缀规则为 &#x27;年&#x27;_开始epoch_结束epoch </span></span><br><span class="line"><span class="comment">-- (例如：table_name_2022_1560240_1563119)</span></span><br><span class="line"><span class="comment">-- 时间范围 每年的第一天的的00:00:00 ~ 每年的最后一天的23:59:59</span></span><br><span class="line"><span class="comment">-- 高度范围 每年的第一天日期的00:00:00 ~ 每年的最后一天日期的23:59:30</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> calc_partition_range_by_year(current_ts TIMESTAMPTZ <span class="operator">=</span> <span class="built_in">current_timestamp</span>)</span><br><span class="line">    <span class="keyword">RETURNS</span> SETOF PARTITION_TABLE_RANGE_DEFINITION</span><br><span class="line">    IMMUTABLE STRICT</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    startup_time timestamptz <span class="operator">=</span> <span class="string">&#x27;2020-08-25T06:00:00+08:00&#x27;</span>::timestamptz;</span><br><span class="line">    first_day_of_year TIMESTAMPTZ <span class="operator">=</span> date_trunc(<span class="string">&#x27;year&#x27;</span>, current_ts);</span><br><span class="line">    year_interval     <span class="type">INTERVAL</span>    <span class="operator">=</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1 year&#x27;</span>;</span><br><span class="line">    last_day_of_year  TIMESTAMPTZ <span class="operator">=</span> first_day_of_year <span class="operator">+</span> year_interval;</span><br><span class="line">    begin_epoch       <span class="type">BIGINT</span>      <span class="operator">=</span> calc_epoch_by_ts(first_day_of_year);</span><br><span class="line">    end_epoch         <span class="type">BIGINT</span>      <span class="operator">=</span> calc_epoch_by_ts(last_day_of_year);</span><br><span class="line">    &quot;year&quot;            <span class="type">INT</span>         <span class="operator">=</span> <span class="built_in">extract</span>(<span class="keyword">YEAR</span> <span class="keyword">FROM</span> first_day_of_year);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">--     考虑边界条件，当计算得出的起始高度小于0，说明时间已经小于主网上线时间。</span></span><br><span class="line">    IF begin_epoch <span class="operator">&lt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        first_day_of_year <span class="operator">=</span> startup_time;</span><br><span class="line">        begin_epoch <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        last_day_of_year <span class="operator">=</span> date_trunc(<span class="string">&#x27;year&#x27;</span>, first_day_of_year) <span class="operator">+</span> year_interval;</span><br><span class="line">        end_epoch <span class="operator">=</span> calc_epoch_by_ts(last_day_of_year);</span><br><span class="line">        &quot;year&quot; <span class="operator">=</span> <span class="built_in">extract</span>(<span class="keyword">YEAR</span> <span class="keyword">FROM</span> first_day_of_year);</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">RETURN</span> QUERY <span class="keyword">SELECT</span> (concat_ws(<span class="string">&#x27;_&#x27;</span>, &quot;year&quot;, begin_epoch, end_epoch))::<span class="type">VARCHAR</span>,</span><br><span class="line">                        current_ts::<span class="type">DATE</span>,</span><br><span class="line">                        begin_epoch,</span><br><span class="line">                        first_day_of_year,</span><br><span class="line">                        end_epoch,</span><br><span class="line">                        last_day_of_year;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<h2 id="区块高度与时间"><a href="#区块高度与时间" class="headerlink" title="区块高度与时间"></a>区块高度与时间</h2><p>2020-08-25T06:00:00+08:00 是Filecoin 上线时间，每30秒一个纪元（高度）。通过与上线时间与高度换算的相对秒数，求得高度对应的时间。反之亦然。其计算方式如下：</p>
<h3 id="高度转换时间"><a href="#高度转换时间" class="headerlink" title="高度转换时间"></a>高度转换时间</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 根据当前时间计算出对应的FileCoin高度，如果不传高度，默认高度为0，即链的起始高度。</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> calc_timestamp_by_epoch(height <span class="type">BIGINT</span> <span class="operator">=</span> <span class="number">0</span>) <span class="keyword">RETURNS</span> <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE</span><br><span class="line">    IMMUTABLE STRICT</span><br><span class="line">    <span class="keyword">LANGUAGE</span> plpgsql</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    baseEpoch <span class="type">INTEGER</span> <span class="operator">=</span> <span class="built_in">extract</span>(EPOCH <span class="keyword">FROM</span> TIMESTAMPTZ <span class="string">&#x27;2020-08-25T06:00:00+08:00&#x27;</span>)::<span class="type">INTEGER</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 根据高度计算时间</span></span><br><span class="line">    <span class="keyword">RETURN</span> to_timestamp(baseEpoch <span class="operator">+</span> height <span class="operator">*</span> <span class="number">30</span>);</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$;</span><br></pre></td></tr></table></figure>
<h3 id="时间转换高度"><a href="#时间转换高度" class="headerlink" title="时间转换高度"></a>时间转换高度</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 根据FileCoin epoch计算出对应的时间，传入的参数如不填，默认当前时间</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> calc_epoch_by_ts(ts <span class="type">timestamp</span> <span class="keyword">with</span> <span class="type">time</span> zone <span class="operator">=</span> <span class="built_in">current_timestamp</span>) <span class="keyword">RETURNS</span> <span class="type">bigint</span></span><br><span class="line">    IMMUTABLE STRICT</span><br><span class="line">    <span class="keyword">LANGUAGE</span> plpgsql</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    baseTime <span class="type">TIMESTAMP</span> <span class="operator">=</span> TIMESTAMPTZ <span class="string">&#x27;2020-08-25T06:00:00+08:00&#x27;</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 根据时间计算高度</span></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="built_in">extract</span>(EPOCH <span class="keyword">FROM</span> (ts <span class="operator">-</span> baseTime))::<span class="type">INTEGER</span> <span class="operator">/</span> <span class="number">30</span>;</span><br><span class="line"><span class="keyword">END</span> </span><br><span class="line">$$;</span><br></pre></td></tr></table></figure>
<h2 id="获取分区名称"><a href="#获取分区名称" class="headerlink" title="获取分区名称"></a>获取分区名称</h2><p>通过系统数据库(pg_catalog)中的表获得分区表名称。如果不存在分区表，返回NULL。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span></span><br><span class="line">    pg_get_part_table_name(main_table <span class="type">VARCHAR</span>, suffix <span class="type">VARCHAR</span>)</span><br><span class="line">    <span class="keyword">RETURNS</span> <span class="type">VARCHAR</span></span><br><span class="line">    IMMUTABLE</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    part_table_name <span class="type">VARCHAR</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">WITH</span> o <span class="keyword">AS</span> (<span class="keyword">SELECT</span> inhrelid <span class="keyword">FROM</span> pg_inherits <span class="keyword">WHERE</span> inhparent <span class="operator">=</span> (concat_ws(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;public&#x27;</span>, main_table))::REGCLASS)</span><br><span class="line">    <span class="keyword">SELECT</span> relname</span><br><span class="line">    <span class="keyword">FROM</span> pg_class</span><br><span class="line">    <span class="keyword">WHERE</span> oid <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> o)</span><br><span class="line">      <span class="keyword">AND</span> relname <span class="operator">=</span> concat_ws(<span class="string">&#x27;_&#x27;</span>, main_table, suffix)</span><br><span class="line">    <span class="keyword">INTO</span> part_table_name;</span><br><span class="line">    <span class="keyword">RETURN</span> part_table_name;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<h2 id="获取分区表分区键（废弃⚠️-at-2022-03-25）"><a href="#获取分区表分区键（废弃⚠️-at-2022-03-25）" class="headerlink" title="获取分区表分区键（废弃⚠️ at 2022-03-25）"></a>获取分区表分区键（废弃⚠️ at 2022-03-25）</h2><p><strong>这个函数用来插入时作为更新键，但实际作为更新键通常是唯一键。唯一键可以是复合键。该函数不适用。</strong></p>
<p><code>pg_get_partkeydef</code> PostgreSQL 内置函数，位于<code>pg_catalog</code> 数据库中，用于提取分区表的分区键定义。<code>strpos</code>和<code>substr</code>函数同样位于<code>pg_catalog</code>数据库中定义，这两个函数参数用法与C语言相同。</p>
<p>通过<code>pg_get_partkeydef</code>函数返回的结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_get_partkeydef(<span class="string">&#x27;test&#x27;</span>::regclass);</span><br><span class="line"><span class="comment">-- Output: RANGE (epoch)</span></span><br></pre></td></tr></table></figure>
<p>使用<code>strpos</code>和<code>substr</code>得到上述返回结果定义列名称。完整实现如下：</p>
<p>通过调用<code>pg_get_part_table_range_key</code> 输入分区表（主表）名称转换成oid，返回分区键名称。非分区表返回结果为NULL。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> pg_get_part_table_range_key(oid REGCLASS)</span><br><span class="line">    <span class="keyword">RETURNS</span> <span class="type">VARCHAR</span></span><br><span class="line">    IMMUTABLE STRICT</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    part_key_def   TEXT <span class="operator">=</span> pg_get_partkeydef(oid); <span class="comment">-- Output: RANGE (epoch)</span></span><br><span class="line">    begin_position <span class="type">INT</span>  <span class="operator">=</span> strpos(part_key_def, <span class="string">&#x27;(&#x27;</span>) <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    def_len        <span class="type">INT</span>  <span class="operator">=</span> length(part_key_def);</span><br><span class="line">    <span class="comment">-- substr(text, int, int) 第二个参数代表位置，第三个参数代表长度</span></span><br><span class="line">    part_key       TEXT <span class="operator">=</span> substr(part_key_def, begin_position, def_len <span class="operator">-</span> begin_position);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 如果不是分区表，返回null</span></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="built_in">cast</span>(part_key <span class="keyword">AS</span> <span class="type">VARCHAR</span>);</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<p>例子</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Range分区</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test11</span><br><span class="line">(</span><br><span class="line">    epoch   <span class="type">INTEGER</span>      <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    miner   <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    balance <span class="type">NUMERIC</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_epoch_miner</span><br><span class="line">        <span class="keyword">UNIQUE</span> (epoch, miner)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (epoch);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> pg_get_part_table_range_key(<span class="string">&#x27;test11&#x27;</span>::regclass);</span><br><span class="line"><span class="comment">-- Output: epoch</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 哈希分区 以及分区表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test22(</span><br><span class="line">    miner <span class="type">varchar</span>(<span class="number">50</span>)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> HASH (miner);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test22_1 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> test22 <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">WITH</span> (MODULUS <span class="number">2</span>, REMAINDER <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> pg_get_part_table_range_key(<span class="string">&#x27;test22&#x27;</span>::regclass);</span><br><span class="line"><span class="comment">-- Output: miner</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 列表分区</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test33(</span><br><span class="line">    miner <span class="type">varchar</span>(<span class="number">50</span>)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> LIST (miner);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test33_1 <span class="keyword">PARTITION</span> <span class="keyword">OF</span> test33 <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;f02439&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> pg_get_part_table_range_key(<span class="string">&#x27;test33&#x27;</span>::regclass);</span><br><span class="line"><span class="comment">-- Output: miner</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 普通非分区表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test66(miner <span class="type">varchar</span>(<span class="number">50</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> pg_get_part_table_range_key(<span class="string">&#x27;test66&#x27;</span>::regclass);</span><br><span class="line"><span class="comment">-- Output: &lt;NULL&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="获取更新唯一键（2022-03-25-新增）"><a href="#获取更新唯一键（2022-03-25-新增）" class="headerlink" title="获取更新唯一键（2022-03-25 新增）"></a>获取更新唯一键（2022-03-25 新增）</h2><p>💡 这里约定，自动建分区表，需要建立一个且只有一个constraint定义。例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> miner_actors</span><br><span class="line">(</span><br><span class="line">    epoch                      <span class="type">BIGINT</span>  <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    miner                      <span class="type">VARCHAR</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    owner                      <span class="type">VARCHAR</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    worker                     <span class="type">VARCHAR</span>,</span><br><span class="line">    controllers                <span class="type">VARCHAR</span>[],</span><br><span class="line">    sector_size                <span class="type">BIGINT</span>,</span><br><span class="line">    power                      <span class="type">DECIMAL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_epoch_miner_actors <span class="keyword">UNIQUE</span> (epoch, miner)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (epoch);</span><br></pre></td></tr></table></figure>
<p>以上有一个唯一性约束<code>uk_epoch_miner_actors</code>，且只要定义一个，其它的约束以添加index方式在外部添加。</p>
<p>然后以下面的语句查询约束字段。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">     <span class="keyword">DISTINCT</span> kcu.column_name</span><br><span class="line"> <span class="keyword">FROM</span></span><br><span class="line">     information_schema.table_constraints <span class="keyword">AS</span> tc</span><br><span class="line">     <span class="keyword">JOIN</span> information_schema.key_column_usage <span class="keyword">AS</span> kcu <span class="keyword">ON</span> tc.constraint_name <span class="operator">=</span> kcu.constraint_name</span><br><span class="line">     <span class="keyword">JOIN</span> information_schema.constraint_column_usage <span class="keyword">AS</span> ccu <span class="keyword">ON</span> ccu.constraint_name <span class="operator">=</span> tc.constraint_name</span><br><span class="line"> <span class="keyword">WHERE</span> constraint_type <span class="operator">=</span> <span class="string">&#x27;UNIQUE&#x27;</span> <span class="keyword">AND</span> tc.table_name <span class="operator">=</span> <span class="string">&#x27;miner_actors&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>作用于下面的代码</p>
<h2 id="获取分区表更新列模版"><a href="#获取分区表更新列模版" class="headerlink" title="获取分区表更新列模版"></a>获取分区表更新列模版</h2><p><strong>modified at 2022-03-25</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> pg_compute_part_table_update_columns(main_table <span class="type">CHARACTER</span> <span class="type">VARYING</span>) <span class="keyword">RETURNS</span> TEXT</span><br><span class="line">    IMMUTABLE</span><br><span class="line">    <span class="keyword">LANGUAGE</span> plpgsql</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    update_columns TEXT;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> string_agg(concat(column_name, <span class="string">&#x27;=$1.&#x27;</span>, column_name), <span class="string">&#x27;, &#x27;</span>) <span class="keyword">AS</span> columns</span><br><span class="line">    <span class="keyword">INTO</span> update_columns</span><br><span class="line">    <span class="keyword">FROM</span> information_schema.columns</span><br><span class="line">    <span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;public&#x27;</span></span><br><span class="line">      <span class="keyword">AND</span> table_name <span class="operator">=</span> main_table</span><br><span class="line">      <span class="keyword">AND</span> column_name <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span></span><br><span class="line">     <span class="keyword">DISTINCT</span> kcu.column_name</span><br><span class="line"> <span class="keyword">FROM</span></span><br><span class="line">     information_schema.table_constraints <span class="keyword">AS</span> tc</span><br><span class="line">     <span class="keyword">JOIN</span> information_schema.key_column_usage <span class="keyword">AS</span> kcu <span class="keyword">ON</span> tc.constraint_name <span class="operator">=</span> kcu.constraint_name</span><br><span class="line">     <span class="keyword">JOIN</span> information_schema.constraint_column_usage <span class="keyword">AS</span> ccu <span class="keyword">ON</span> ccu.constraint_name <span class="operator">=</span> tc.constraint_name</span><br><span class="line"> <span class="keyword">WHERE</span> constraint_type <span class="operator">=</span> <span class="string">&#x27;UNIQUE&#x27;</span> <span class="keyword">AND</span> tc.table_name <span class="operator">=</span> main_table);</span><br><span class="line">    <span class="keyword">RETURN</span> update_columns;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$;</span><br></pre></td></tr></table></figure>
<p>创建update 更新约束字段</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> pg_compute_constraint_keys(main_table <span class="type">VARCHAR</span>) <span class="keyword">RETURNS</span> TEXT</span><br><span class="line">    IMMUTABLE</span><br><span class="line">    <span class="keyword">LANGUAGE</span> plpgsql</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    ukeys TEXT;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">WITH</span> t <span class="keyword">AS</span> (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> kcu.column_name</span><br><span class="line">               <span class="keyword">FROM</span> information_schema.table_constraints <span class="keyword">AS</span> tc</span><br><span class="line">                        <span class="keyword">JOIN</span> information_schema.key_column_usage <span class="keyword">AS</span> kcu <span class="keyword">ON</span> tc.constraint_name <span class="operator">=</span> kcu.constraint_name</span><br><span class="line">                        <span class="keyword">JOIN</span> information_schema.constraint_column_usage <span class="keyword">AS</span> ccu</span><br><span class="line">                             <span class="keyword">ON</span> ccu.constraint_name <span class="operator">=</span> tc.constraint_name</span><br><span class="line">               <span class="keyword">WHERE</span> constraint_type <span class="operator">=</span> <span class="string">&#x27;UNIQUE&#x27;</span></span><br><span class="line">                 <span class="keyword">AND</span> tc.table_name <span class="operator">=</span> main_table)</span><br><span class="line">    <span class="keyword">SELECT</span> string_agg(concat(t.column_name, <span class="string">&#x27;=$1.&#x27;</span>, t.column_name), <span class="string">&#x27; AND &#x27;</span>)</span><br><span class="line">    <span class="keyword">FROM</span> t</span><br><span class="line">    <span class="keyword">INTO</span> ukeys;</span><br><span class="line">    <span class="keyword">RETURN</span> ukeys;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$;</span><br></pre></td></tr></table></figure>
<h2 id="创建新分区"><a href="#创建新分区" class="headerlink" title="创建新分区"></a>创建新分区</h2><h3 id="分区Meta表"><a href="#分区Meta表" class="headerlink" title="分区Meta表"></a>分区Meta表</h3><p>分区meta表记录了分区表的分区信息、创建时间和分区范围。该表内的记录应在创建新分区时被记录。<code>part_type</code>字段表示范围分区、哈希分区或列表分区。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> part_tables</span><br><span class="line">(</span><br><span class="line">    id           SERIAL   <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    tb_name      <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    part_type    <span class="type">SMALLINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    part_table   <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    begin_time   TIMESTAMPTZ,</span><br><span class="line">    end_time     TIMESTAMPTZ,</span><br><span class="line">    created_time TIMESTAMPTZ       <span class="keyword">DEFAULT</span> <span class="built_in">current_timestamp</span>,</span><br><span class="line">    <span class="comment">-- 分区表需要唯一</span></span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_part_table_name <span class="keyword">UNIQUE</span> (tb_name, part_table),</span><br><span class="line">    <span class="keyword">CHECK</span> (part_type <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>)) <span class="comment">-- 0 range / 1 hash /2 list</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h3><p>这里创建新分区一定要加上 <code>IF NOT EXISTS</code>判断，在同一个事务中，批量插入时，<code>pg_catalog</code>表内未完成实际分区表的创建，所以查询出来的结果是空，会重复创建。通过<code>IF NOT EXISTS</code>规避同一事务中的重复建表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span></span><br><span class="line">    create_new_partition_table(main_table <span class="type">VARCHAR</span>, part_table_type <span class="type">SMALLINT</span>, part_def PARTITION_TABLE_RANGE_DEFINITION)</span><br><span class="line">    <span class="keyword">RETURNS</span> <span class="type">VARCHAR</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    part_table_name TEXT;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    part_table_name <span class="operator">=</span> concat_ws(<span class="string">&#x27;_&#x27;</span>, main_table, part_def.suffix);</span><br><span class="line">    <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;CREATE TABLE IF NOT EXISTS %s PARTITION OF %s FOR VALUES FROM (%s) TO (%s)&#x27;</span>,</span><br><span class="line">                   part_table_name, main_table, part_def.begin_epoch, part_def.end_epoch);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> part_tables</span><br><span class="line">(</span><br><span class="line">    id           SERIAL   <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    tb_name      <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    part_type    <span class="type">SMALLINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    part_table   <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    begin_time   TIMESTAMPTZ,</span><br><span class="line">    end_time     TIMESTAMPTZ,</span><br><span class="line">    created_time TIMESTAMPTZ       <span class="keyword">DEFAULT</span> <span class="built_in">current_timestamp</span>,</span><br><span class="line">  			<span class="comment">-- 分区表需要唯一</span></span><br><span class="line">  			<span class="keyword">CONSTRAINT</span> uk_part_table_name <span class="keyword">UNIQUE</span> (tb_name, part_table),</span><br><span class="line">        <span class="keyword">CHECK</span> (part_type <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>)) <span class="comment">-- 0 range / 1 hash /2 list</span></span><br><span class="line">);</span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> part_tables(tb_name, part_type, part_table, begin_time, end_time, created_time)</span><br><span class="line">    <span class="keyword">VALUES</span> (main_table, part_table_type, part_table_name,</span><br><span class="line">            part_def.begin_time, part_def.end_time, <span class="built_in">current_timestamp</span>)</span><br><span class="line">    <span class="keyword">ON</span> CONFLICT (tb_name, part_table) DO NOTHING ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span> part_table_name;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<h1 id="重写规则"><a href="#重写规则" class="headerlink" title="重写规则"></a>重写规则</h1><p>通过PostgreSQL数据库规则系统，改变数据库分区表默认的INSERT/UPDATE操作，来达到在插入或更新前，判断目标分区是否存在，如不存在创建之的目的。</p>
<p>为方便后续对分区表的维护，额外建立一张独立的数据表，存放新创建的分区以及创建时间。可以根据时间对分区表合理裁剪。</p>
<h2 id="准备分区表"><a href="#准备分区表" class="headerlink" title="准备分区表"></a>准备分区表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table</span><br><span class="line">(</span><br><span class="line">    epoch <span class="type">INT</span>,</span><br><span class="line">    miner <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    balance <span class="type">DECIMAL</span>,</span><br><span class="line">    code <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_epoch_miner <span class="keyword">UNIQUE</span> (epoch, miner)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (epoch);</span><br><span class="line"></span><br><span class="line">example<span class="operator">=</span># \d<span class="operator">+</span> example_table</span><br><span class="line">              Partitioned <span class="keyword">table</span> &quot;public.example_table&quot;</span><br><span class="line"> <span class="keyword">Column</span>  <span class="operator">|</span>          Type          <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Storage  <span class="operator">|</span> Stats target <span class="operator">|</span> </span><br><span class="line"><span class="comment">---------+------------------------+----------+---------+----------+--------------+-</span></span><br><span class="line"> epoch   <span class="operator">|</span> <span class="type">integer</span>                <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> plain    <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> miner   <span class="operator">|</span> <span class="type">character</span> <span class="type">varying</span>(<span class="number">100</span>) <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> extended <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> balance <span class="operator">|</span> <span class="type">numeric</span>                <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> main     <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> code    <span class="operator">|</span> <span class="type">character</span> <span class="type">varying</span>(<span class="number">100</span>) <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> extended <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"><span class="keyword">Partition</span> key: <span class="keyword">RANGE</span> (epoch)</span><br><span class="line">Indexes:</span><br><span class="line">    &quot;uk_epoch_miner&quot; <span class="keyword">UNIQUE</span> <span class="keyword">CONSTRAINT</span>, btree (epoch, miner)</span><br><span class="line">Number <span class="keyword">of</span> partitions: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h2 id="插入（INSERT）"><a href="#插入（INSERT）" class="headerlink" title="插入（INSERT）"></a>插入（INSERT）</h2><p>替代数据库分区表默认的插入操作，需要考虑默认插入动作的几个关键要素：自动路由到对应的表分区进行插入，处理唯一键冲突。</p>
<h3 id="自动路由"><a href="#自动路由" class="headerlink" title="自动路由"></a>自动路由</h3><p>自动路由的前提是对应的表分区已存在。它分成两个步骤：</p>
<ul>
<li>创建新分区</li>
</ul>
<p>在插入行数据前，使用函数<code>pg_get_part_table_name</code>查找新插入的记录分区字段所对应的表分区，如果在数据库中不存在，则新创建。</p>
<ul>
<li>插入数据</li>
</ul>
<p>向具体的表分区插入数据。</p>
<h3 id="处理唯一键冲突"><a href="#处理唯一键冲突" class="headerlink" title="处理唯一键冲突"></a>处理唯一键冲突</h3><p>使用重写规则有一个限制，就是无法处理唯一键冲突更新。</p>
<p>无法对具有INSERT或者UPDATE规则的表使用带有ON CONFLICT子句的INSERT</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> from_table <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;333&#x27;</span>) <span class="keyword">ON</span> CONFLICT(col1) DO <span class="keyword">UPDATE</span> <span class="keyword">SET</span> data <span class="operator">=</span> excluded.data;</span><br></pre></td></tr></table></figure>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>A000  feature_not_supported</span><br></pre></td></tr></table></figure>
<p>因此，需要处理<code>unique_violation</code>的执行错误。使用<code>EXCEPTION</code>捕获<code>unique_violation</code>的错误，执行分区表UPDATE。</p>
<p>注意，一旦捕获<code>unique_violation</code>并处理实现唯一键冲突更新的操作，意味着替代的INSERT操作将天生具有upsert的功能。</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>一、创建插入函数。</p>
<p>根据数据库规则语法，规则仅支持SELECT/INSERT/UPDATE/DELETE操作，因此要执行一系列动作需要创建一个存储过程来实现。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> insert_action(table_row miner_actors) <span class="keyword">RETURNS</span> VOID</span><br><span class="line"><span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    main_table <span class="type">VARCHAR</span> <span class="operator">=</span> <span class="string">&#x27;example_table&#x27;</span>;</span><br><span class="line">    part_table_type <span class="type">SMALLINT</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    range_ts        TIMESTAMPTZ                      <span class="operator">=</span> calc_timestamp_by_epoch(table_row.epoch);</span><br><span class="line">    part_def        PARTITION_TABLE_RANGE_DEFINITION <span class="operator">=</span> calc_partition_range_by_day(range_ts);</span><br><span class="line">    part_table_name <span class="type">VARCHAR</span>                          <span class="operator">=</span> pg_get_part_table_name(main_table, part_def.suffix);</span><br><span class="line">    update_columns  TEXT;</span><br><span class="line">    constraint_keys TEXT;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    RAISE NOTICE <span class="string">&#x27;suffix:%; begin_epoch:%; end_epoch:%; begin_time:%; end_time:%&#x27;</span>,</span><br><span class="line">        part_def.suffix, part_def.begin_epoch, part_def.end_epoch, part_def.begin_time, part_def.end_time;</span><br><span class="line">    RAISE NOTICE <span class="string">&#x27;part_table_name: %&#x27;</span>, part_table_name;</span><br><span class="line">    IF part_table_name ISNULL <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SELECT</span> create_new_partition_table(main_table, part_table_type, part_def)</span><br><span class="line">        <span class="keyword">INTO</span> part_table_name;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;INSERT INTO %s SELECT $1.*&#x27;</span>, part_table_name) <span class="keyword">USING</span> table_row;</span><br><span class="line">EXCEPTION</span><br><span class="line">    <span class="keyword">WHEN</span> unique_violation <span class="keyword">THEN</span></span><br><span class="line">        update_columns <span class="operator">=</span> pg_compute_part_table_update_columns(main_table);</span><br><span class="line">        constraint_keys <span class="operator">=</span> pg_compute_constraint_keys(main_table);</span><br><span class="line">        RAISE NOTICE <span class="string">&#x27;%&#x27;</span>, format(<span class="string">&#x27;UPDATE %s SET %s WHERE %s&#x27;</span>, part_table_name, update_columns, constraint_keys);</span><br><span class="line">        <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;UPDATE %s SET %s WHERE %s&#x27;</span>, part_table_name, update_columns, constraint_keys) <span class="keyword">USING</span> table_row;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<p>二、创建INSERT RULE。</p>
<p>在分区表主表上创建一条规则，其方式是<code>INSTEAD</code>默认INSERT操作。其中<code>new</code>是一个内置变量，代表新插入的记录行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> RULE upsert_part_data <span class="keyword">AS</span> <span class="keyword">ON</span> <span class="keyword">INSERT</span> <span class="keyword">TO</span> example_table DO INSTEAD <span class="keyword">SELECT</span> insert_action(<span class="keyword">new</span>);</span><br></pre></td></tr></table></figure>
<p> 三、插入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table(epoch, miner, balance, code) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;f02438&#x27;</span>, <span class="string">&#x27;100&#x27;</span>, <span class="string">&#x27;Good&#x27;</span>);</span><br><span class="line"></span><br><span class="line">example<span class="operator">=</span># \d<span class="operator">+</span> example_table</span><br><span class="line">                 Partitioned <span class="keyword">table</span> &quot;public.example_table&quot;</span><br><span class="line"> <span class="keyword">Column</span>  <span class="operator">|</span>          Type          <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Storage  <span class="operator">|</span> Stats target <span class="operator">|</span> </span><br><span class="line"><span class="comment">---------+------------------------+----------+---------+----------+--------------+-</span></span><br><span class="line"> epoch   <span class="operator">|</span> <span class="type">integer</span>                <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> plain    <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> miner   <span class="operator">|</span> <span class="type">character</span> <span class="type">varying</span>(<span class="number">100</span>) <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> extended <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> balance <span class="operator">|</span> <span class="type">numeric</span>                <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> main     <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> code    <span class="operator">|</span> <span class="type">character</span> <span class="type">varying</span>(<span class="number">100</span>) <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> extended <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"><span class="keyword">Partition</span> key: <span class="keyword">RANGE</span> (epoch)</span><br><span class="line">Indexes:</span><br><span class="line">    &quot;uk_epoch_miner&quot; <span class="keyword">UNIQUE</span> <span class="keyword">CONSTRAINT</span>, btree (epoch, miner)</span><br><span class="line">Rules:</span><br><span class="line">    upsert_part_data <span class="keyword">AS</span></span><br><span class="line">    <span class="keyword">ON</span> <span class="keyword">INSERT</span> <span class="keyword">TO</span> example_table DO INSTEAD  <span class="keyword">SELECT</span> insert_action(new.<span class="operator">*</span>) <span class="keyword">AS</span> insert_action</span><br><span class="line">Partitions: example_table_2020_08_25_0_2159 <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">0</span>) <span class="keyword">TO</span> (<span class="number">2159</span>)</span><br></pre></td></tr></table></figure>
<h2 id="更新（UPDATE）"><a href="#更新（UPDATE）" class="headerlink" title="更新（UPDATE）"></a>更新（UPDATE）</h2><p>替代数据库分区表默认更新操作，需要考虑以下几个因素：普通更新和分区移动。</p>
<h3 id="普通更新"><a href="#普通更新" class="headerlink" title="普通更新"></a>普通更新</h3><p>对于分区列相同的更新，不需要执行删除命令，也不需要创建新不存在的分区表，直接UPDATE目标表。</p>
<h3 id="分区移动"><a href="#分区移动" class="headerlink" title="分区移动"></a>分区移动</h3><p>对于更新了分区列的数据，要查找新的分区表是否存在，如果不存在需要创建。然后将旧数据删除，在新表中插入新纪录。</p>
<h3 id="具体实现-1"><a href="#具体实现-1" class="headerlink" title="具体实现"></a>具体实现</h3><p>一、创建存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span></span><br><span class="line">    update_action(new_row miner_actors, old_row miner_actors)</span><br><span class="line">    <span class="keyword">RETURNS</span> VOID <span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    main_table          <span class="type">VARCHAR</span>                          <span class="operator">=</span> <span class="string">&#x27;example_table&#x27;</span>;</span><br><span class="line">    part_table_type <span class="type">SMALLINT</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    new_range_ts        TIMESTAMPTZ                      <span class="operator">=</span> calc_timestamp_by_epoch(new_row.epoch);</span><br><span class="line">    new_part_def        PARTITION_TABLE_RANGE_DEFINITION <span class="operator">=</span> calc_partition_range_by_day(new_range_ts);</span><br><span class="line">    new_part_table_name <span class="type">VARCHAR</span>                          <span class="operator">=</span> pg_get_part_table_name(main_table, new_part_def.suffix);</span><br><span class="line">    old_range_ts        TIMESTAMPTZ;</span><br><span class="line">    old_part_def        PARTITION_TABLE_RANGE_DEFINITION;</span><br><span class="line">    old_part_table_name <span class="type">VARCHAR</span>;</span><br><span class="line">    update_columns      TEXT;</span><br><span class="line">    constraint_keys TEXT;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    constraint_keys <span class="operator">=</span> pg_compute_constraint_keys(main_table);</span><br><span class="line">    IF new_row.epoch <span class="operator">=</span> old_row.epoch <span class="keyword">THEN</span></span><br><span class="line">        RAISE NOTICE <span class="string">&#x27;update in same table&#x27;</span>;</span><br><span class="line"><span class="comment">--         旧数据存在或条件不存在，这里只是做单纯的update更新分区数据</span></span><br><span class="line">        update_columns <span class="operator">=</span> pg_compute_part_table_update_columns(main_table);</span><br><span class="line">        <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;UPDATE %s SET %s WHERE %s&#x27;</span>, new_part_table_name, update_columns, constraint_keys) <span class="keyword">USING</span> new_row;</span><br><span class="line">        <span class="keyword">RETURN</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">    IF new_part_table_name ISNULL <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SELECT</span> create_new_partition_table(main_table, part_table_type, new_part_def)</span><br><span class="line">        <span class="keyword">INTO</span> new_part_table_name;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">    old_range_ts <span class="operator">=</span> calc_timestamp_by_epoch(old_row.epoch);</span><br><span class="line">    old_part_def <span class="operator">=</span> calc_partition_range_by_day(old_range_ts);</span><br><span class="line">    old_part_table_name <span class="operator">=</span> pg_get_part_table_name(main_table, old_part_def.suffix);</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- delete 动作要放在这里，这里有移动操作。</span></span><br><span class="line">    <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;DELETE FROM %s WHERE %s&#x27;</span>, old_part_table_name, constraint_keys) <span class="keyword">USING</span> old_row;</span><br><span class="line">    <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;INSERT INTO %s SELECT $1.*&#x27;</span>, new_part_table_name) <span class="keyword">USING</span> new_row;</span><br><span class="line">    <span class="keyword">RETURN</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<p>二、创建UPDATE RULE</p>
<p>在分区表主表上创建一条更新规则，其方式是<code>INSTEAD</code>默认UPDATE操作。其中<code>new</code>和<code>old</code>是内置变量，代表新更新的数据和旧数据行。</p>
<p><strong>这里的旧的数据行是通过where条件获知的，新的数据行是根据update内set获知的。所以在执行该更新执行计划的时候它会先收集数据，然后执行规则。所以old可以根据唯一键来查找。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> RULE update_part_data <span class="keyword">AS</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">TO</span> example_table DO INSTEAD <span class="keyword">SELECT</span> update_action(<span class="keyword">new</span>, <span class="keyword">old</span>);</span><br></pre></td></tr></table></figure>
<p>  三、更新</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> example_table <span class="keyword">SET</span> epoch <span class="operator">=</span> <span class="number">3000</span>, balance <span class="operator">=</span> <span class="string">&#x27;99&#x27;</span>, code <span class="operator">=</span> <span class="string">&#x27;Good+&#x27;</span> <span class="keyword">WHERE</span> epoch <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">example<span class="operator">=</span># \d<span class="operator">+</span> example_table</span><br><span class="line">                                 Partitioned <span class="keyword">table</span> &quot;public.example_table&quot;</span><br><span class="line"> <span class="keyword">Column</span>  <span class="operator">|</span>          Type          <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Storage  <span class="operator">|</span> Stats target <span class="operator">|</span> </span><br><span class="line"><span class="comment">---------+------------------------+----------+---------+----------+--------------+-</span></span><br><span class="line"> epoch   <span class="operator">|</span> <span class="type">integer</span>                <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> plain    <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> miner   <span class="operator">|</span> <span class="type">character</span> <span class="type">varying</span>(<span class="number">100</span>) <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> extended <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> balance <span class="operator">|</span> <span class="type">numeric</span>                <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> main     <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"> code    <span class="operator">|</span> <span class="type">character</span> <span class="type">varying</span>(<span class="number">100</span>) <span class="operator">|</span>          <span class="operator">|</span>         <span class="operator">|</span> extended <span class="operator">|</span>              <span class="operator">|</span></span><br><span class="line"><span class="keyword">Partition</span> key: <span class="keyword">RANGE</span> (epoch)</span><br><span class="line">Indexes:</span><br><span class="line">    &quot;uk_epoch_miner&quot; <span class="keyword">UNIQUE</span> <span class="keyword">CONSTRAINT</span>, btree (epoch, miner)</span><br><span class="line">Rules:</span><br><span class="line">    update_part_data <span class="keyword">AS</span></span><br><span class="line">    <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">TO</span> example_table DO INSTEAD  <span class="keyword">SELECT</span> update_action(new.<span class="operator">*</span>, old.<span class="operator">*</span>) <span class="keyword">AS</span> update_action</span><br><span class="line">    upsert_part_data <span class="keyword">AS</span></span><br><span class="line">    <span class="keyword">ON</span> <span class="keyword">INSERT</span> <span class="keyword">TO</span> example_table DO INSTEAD  <span class="keyword">SELECT</span> insert_action(new.<span class="operator">*</span>) <span class="keyword">AS</span> insert_action</span><br><span class="line">Partitions: example_table_2020_08_25_0_2159 <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">0</span>) <span class="keyword">TO</span> (<span class="number">2159</span>),</span><br><span class="line">            example_table_2020_08_26_2160_5039 <span class="keyword">FOR</span> <span class="keyword">VALUES</span> <span class="keyword">FROM</span> (<span class="number">2160</span>) <span class="keyword">TO</span> (<span class="number">5039</span>)</span><br></pre></td></tr></table></figure>
<h1 id="分区表维护"><a href="#分区表维护" class="headerlink" title="分区表维护"></a>分区表维护</h1><h2 id="规则替换"><a href="#规则替换" class="headerlink" title="规则替换"></a>规则替换</h2><p>封装一个存储过程，将创建insert_action函数和update_action函数放入其中。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">PROCEDURE</span></span><br><span class="line">    create_auto_partition(table_name <span class="type">VARCHAR</span>, range_type <span class="type">VARCHAR</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;week&#x27;</span>)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">$$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    insert_func_name TEXT :<span class="operator">=</span> concat_ws(<span class="string">&#x27;_&#x27;</span>, table_name, <span class="string">&#x27;insert_action&#x27;</span>);</span><br><span class="line">    update_func_name TEXT :<span class="operator">=</span> concat_ws(<span class="string">&#x27;_&#x27;</span>, table_name, <span class="string">&#x27;update_action&#x27;</span>);</span><br><span class="line">    insert_tpl       TEXT;</span><br><span class="line">    update_tpl       TEXT;</span><br><span class="line">    range_func_name  TEXT;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF range_type <span class="operator">=</span> <span class="string">&#x27;day&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        range_func_name <span class="operator">=</span> <span class="string">&#x27;calc_partition_range_by_day&#x27;</span>;</span><br><span class="line">    ELSEIF range_type <span class="operator">=</span> <span class="string">&#x27;week&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        range_func_name <span class="operator">=</span> <span class="string">&#x27;calc_partition_range_by_week_of_year&#x27;</span>;</span><br><span class="line">    ELSEIF range_type <span class="operator">=</span> <span class="string">&#x27;month&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        range_func_name <span class="operator">=</span> <span class="string">&#x27;calc_partition_range_by_month&#x27;</span>;</span><br><span class="line">    ELSEIF range_type <span class="operator">=</span> <span class="string">&#x27;year&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        range_func_name <span class="operator">=</span> <span class="string">&#x27;calc_partition_range_by_year&#x27;</span>;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        RAISE EXCEPTION <span class="string">&#x27;unsupported range type(only in day, week, month, year)&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    insert_tpl :<span class="operator">=</span> E<span class="string">&#x27;CREATE OR REPLACE FUNCTION &#x27;</span> <span class="operator">||</span> insert_func_name <span class="operator">||</span> <span class="string">&#x27;(table_row &#x27;</span> <span class="operator">||</span> table_name <span class="operator">||</span> <span class="string">&#x27;) &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;RETURNS VOID AS &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;$body$ &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;DECLARE &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;    main_table VARCHAR = &#x27;&#x27;&#x27;</span> <span class="operator">||</span> table_name <span class="operator">||</span> <span class="string">&#x27;&#x27;&#x27;; &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;part_table_type SMALLINT = 0; &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;range_ts        TIMESTAMPTZ                      = calc_timestamp_by_epoch(table_row.epoch); &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;part_def        PARTITION_TABLE_RANGE_DEFINITION = &#x27;</span> <span class="operator">||</span> range_func_name <span class="operator">||</span> <span class="string">&#x27;(range_ts); &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;part_table_name VARCHAR                          = pg_get_part_table_name(main_table, part_def.suffix); &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;update_columns  TEXT; &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;constraint_keys TEXT; &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;BEGIN &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;IF part_table_name ISNULL THEN &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;SELECT create_new_partition_table(main_table, part_table_type, part_def) &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;INTO part_table_name; &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;END IF; &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;EXECUTE format(&#x27;&#x27;INSERT INTO %s SELECT $1.*&#x27;&#x27;, part_table_name) USING table_row; &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;EXCEPTION &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;    WHEN unique_violation THEN &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;        update_columns = pg_compute_part_table_update_columns(main_table); &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;        constraint_keys = pg_compute_constraint_keys(main_table); &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;EXECUTE format(&#x27;&#x27;UPDATE %s SET %s WHERE %s &#x27;&#x27;, part_table_name, update_columns, constraint_keys) USING table_row; &#x27;</span> <span class="operator">||</span></span><br><span class="line">                  <span class="string">&#x27;END $body$ LANGUAGE plpgsql&#x27;</span>;</span><br><span class="line">    <span class="keyword">EXECUTE</span> insert_tpl;</span><br><span class="line">    <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;DROP RULE IF EXISTS upsert_part_data ON %s&#x27;</span>, table_name);</span><br><span class="line">    <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;CREATE RULE upsert_part_data AS ON INSERT TO %s DO INSTEAD SELECT %s(new)&#x27;</span>, table_name, insert_func_name);</span><br><span class="line"></span><br><span class="line">    update_tpl :<span class="operator">=</span> <span class="string">&#x27;CREATE OR REPLACE FUNCTION &#x27;</span><span class="operator">||</span> update_func_name <span class="operator">||</span> <span class="string">&#x27;(new_row &#x27;</span><span class="operator">||</span> table_name <span class="operator">||</span><span class="string">&#x27;, old_row &#x27;</span><span class="operator">||</span> table_name <span class="operator">||</span><span class="string">&#x27;)&#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;    RETURNS VOID AS &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;$body$ &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;DECLARE &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;    main_table VARCHAR = &#x27;&#x27;&#x27;</span><span class="operator">||</span> table_name <span class="operator">||</span><span class="string">&#x27;&#x27;&#x27;; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;part_table_type SMALLINT = 0; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;new_range_ts        TIMESTAMPTZ                      = calc_timestamp_by_epoch(new_row.epoch); &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;new_part_def        PARTITION_TABLE_RANGE_DEFINITION = &#x27;</span><span class="operator">||</span> range_func_name <span class="operator">||</span><span class="string">&#x27;(new_range_ts); &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;new_part_table_name VARCHAR                          = pg_get_part_table_name(main_table, new_part_def.suffix); &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;old_range_ts        TIMESTAMPTZ; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;old_part_def        PARTITION_TABLE_RANGE_DEFINITION; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;old_part_table_name VARCHAR; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;update_columns      TEXT; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;constraint_keys     TEXT;&#x27;</span>  <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;BEGIN &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;constraint_keys = pg_compute_constraint_keys(main_table); &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;IF new_row.epoch = old_row.epoch THEN &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;update_columns = pg_compute_part_table_update_columns(main_table); &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;EXECUTE format(&#x27;&#x27;UPDATE %s SET %s WHERE %s&#x27;&#x27;, new_part_table_name, update_columns, constraint_keys) USING new_row; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;RETURN; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;END IF; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;IF new_part_table_name ISNULL THEN &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;SELECT create_new_partition_table(main_table, part_table_type, new_part_def) &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;INTO new_part_table_name; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;END IF; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;old_range_ts = calc_timestamp_by_epoch(old_row.epoch); &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;old_part_def = &#x27;</span> <span class="operator">||</span> range_func_name <span class="operator">||</span> <span class="string">&#x27;(old_range_ts); &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;old_part_table_name = pg_get_part_table_name(main_table, old_part_def.suffix); &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;EXECUTE format(&#x27;&#x27;DELETE FROM %s WHERE %s&#x27;&#x27;, old_part_table_name, constraint_keys) USING old_row; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;EXECUTE format(&#x27;&#x27;INSERT INTO %s SELECT $1.*&#x27;&#x27;, new_part_table_name) USING new_row; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;RETURN; &#x27;</span> <span class="operator">||</span></span><br><span class="line"><span class="string">&#x27;END $body$ LANGUAGE plpgsql&#x27;</span>;</span><br><span class="line">    <span class="keyword">EXECUTE</span> update_tpl;</span><br><span class="line">    <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;DROP RULE IF EXISTS update_part_data ON %s&#x27;</span>, table_name);</span><br><span class="line">    <span class="keyword">EXECUTE</span> format(<span class="string">&#x27;CREATE RULE update_part_data AS ON UPDATE TO %s DO INSTEAD SELECT %s(new, old)&#x27;</span>, table_name, update_func_name);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure>
<p>调用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> create_auto_partition(<span class="string">&#x27;example_table&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>上述简化了操作步骤。对于公共函数仍然需要提前部署。</p>
<h2 id="裁剪"><a href="#裁剪" class="headerlink" title="裁剪"></a>裁剪</h2><p>//TODO</p>
<h2 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h2><p>//TODO</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="创建自动分区表的步骤"><a href="#创建自动分区表的步骤" class="headerlink" title="创建自动分区表的步骤"></a>创建自动分区表的步骤</h2><p>一、准备公共函数</p>
<p>见 <strong>函数</strong> 一章，和 <strong>规则替换</strong> 一节</p>
<p>二、创建分区表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table</span><br><span class="line">(</span><br><span class="line">    epoch <span class="type">INT</span>,</span><br><span class="line">    miner <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    balance <span class="type">DECIMAL</span>,</span><br><span class="line">    code <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_epoch_miner <span class="keyword">UNIQUE</span> (epoch, miner)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (epoch);</span><br></pre></td></tr></table></figure>
<p>三、创建INSERT/UPDATE替换函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> create_auto_partition(<span class="string">&#x27;example_table&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> example_table(epoch, miner, balance, code) <span class="keyword">SELECT</span> i, <span class="string">&#x27;f03367&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;Good&#x27;</span> <span class="keyword">FROM</span> generate_series(<span class="number">1</span>, <span class="number">1500000</span>) g(i);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- completed in 10 m 26 s 339 ms</span></span><br></pre></td></tr></table></figure>
<p>插入150万测试数据，花费10分钟左右。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p><a target="_blank" rel="noopener" href="http://postgres.cn/docs/13/ddl-partitioning.html">表分区</a></p>
<p><a target="_blank" rel="noopener" href="http://postgres.cn/docs/13/errcodes-appendix.html">附录 A. PostgreSQL错误代码</a></p>
<p><a target="_blank" rel="noopener" href="http://www.postgres.cn/docs/13/sql-createrule.html">CREATE RULE</a></p>
<h2 id="网上文章"><a href="#网上文章" class="headerlink" title="网上文章"></a>网上文章</h2><p><a target="_blank" rel="noopener" href="https://itbilu.com/database/postgre/E12ilqZXx.html">PostgreSQL中的函数之日期时间函数</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/603280">自动创建分区实践(写入触发器)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangyongze_z/article/details/114820640">PostgreSQL 异常捕获（EXCEPTION）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/datacap-quality-adj-power">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/datacap-quality-adj-power" class="post-title-link" itemprop="url">如何使用DataCap获得10倍有效算力</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-22 15:36:54 / 修改时间：23:07:00" itemprop="dateCreated datePublished" datetime="2022-09-22T15:36:54+08:00">2022-09-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BlockChain/" itemprop="url" rel="index"><span itemprop="name">BlockChain</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/datacap-quality-adj-power#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="/datacap-quality-adj-power" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="何谓10倍有效算力"><a href="#何谓10倍有效算力" class="headerlink" title="何谓10倍有效算力"></a>何谓10倍有效算力</h2><p>存有DataCap订单的封装扇区，将可获得最高10倍于没有任何订单的封装扇区（承诺容量扇区，简称CC扇区）或非DataCap订单的封装扇区所获得的有效算力。这部分通过封装存有DataCap订单的扇区所获得的有效算力，我们统称为10倍有效算力。</p>
<h2 id="DataCap是什么"><a href="#DataCap是什么" class="headerlink" title="DataCap是什么"></a>DataCap是什么</h2><p>作为一个区块链网络，Filecoin提供了一个稳健的分布式平台，任何人都可以在上面存储数据。网络上的存储提供者根据其提供的存储服务的可靠性获得区块奖励。</p>
<p>为了最大化Filecoin可以支持的有用存储数量，<a target="_blank" rel="noopener" href="https://fil.org/filplus/">Filecoin Plus</a> 作为一个社交信任层被提出来。用户可以使用一个新型的资源DataCap(数据配额)来与特定的存储提供者达成交易提议，这些存储提供者则有强大的激励因素来存储这些数据，因为这会在未来增加他们的区块奖励分成份额。</p>
<p>DataCap 是Filecoin网络里的一种资源，它从公证人手上流转到可信的用户。除了FIL外，这些用户根据协议价格来使用DataCap来达成存储交易提议。DataCap是一个“一次性积分”，即它一旦使用就会被消耗掉。</p>
<p>这时，DataCap无法在用户地址之间互转。在网络上，存储提供者可以通过提供由DataCap达成的交易提议来获得额外的奖励。</p>
<h2 id="10倍有效算力正确获得方式"><a href="#10倍有效算力正确获得方式" class="headerlink" title="10倍有效算力正确获得方式"></a>10倍有效算力正确获得方式</h2><h3 id="有效算力计算公式"><a href="#有效算力计算公式" class="headerlink" title="有效算力计算公式"></a>有效算力计算公式</h3><p>对含有DataCap订单 的扇区，参与有效算力计算，将有两部分组成：计算订单权重，计算扇区有效算力。</p>
<h4 id="计算订单权重"><a href="#计算订单权重" class="headerlink" title="计算订单权重"></a>计算订单权重</h4><p>订单空间大小 = PieceSize（例如32G或64G，Piece没有固定大小，以扇区大小为上限）</p>
<p>订单存续周期 = EndEpoch - StartEpoch (这里可以理解为订单天数，例如：540天)</p>
<p><strong>订单权重</strong> = 订单空间大小 x 订单存续周期</p>
<h4 id="计算扇区有效算力"><a href="#计算扇区有效算力" class="headerlink" title="计算扇区有效算力"></a>计算扇区有效算力</h4><p>扇区存续周期 = 扇区Expiration - Activation （这里可以理解为扇区的存续天数，例如：540天）</p>
<p><strong>*</strong>扇区存续周期是首次封装时的时长</p>
<p>扇区权重 = 扇区大小 x 扇区存续周期</p>
<p>有效扇区 = 扇区大小 x [((扇区权重 - 订单权重)x10+订单权重x100)/扇区权重x10]</p>
<p>简化上述公式得出以下公式：</p>
<p>有效扇区 = 扇区大小 x [(扇区权重x10 - 订单权重x90)/扇区权重x10]</p>
<p>当且仅当订单权重=扇区权重时，有效扇区才是10倍于普通扇区。这意味着，订单的存续周期和订单的空间大小与扇区的存续周期以及扇区的空间大小一致时，才是10倍有效算力。</p>
<h2 id="术语说明"><a href="#术语说明" class="headerlink" title="术语说明"></a>术语说明</h2><h3 id="Piece"><a href="#Piece" class="headerlink" title="Piece"></a>Piece</h3><p>Filecoin Piece 是用户在 Filecoin 网络上存储的数据的主要协商单元。 Filecoin Piece 不是一个存储单元，它没有特定的大小，而是以扇区大小为上限。 Filecoin Piece 可以是任意大小，但如果 Piece 大于矿工支持的 Sector 的大小，则必须将其拆分为更多 Pieces，以便每个 Piece 适合一个 Sector。</p>
<p>Piece 是代表文件的全部或部分的对象，由存储客户端和存储矿工在交易中使用。 存储客户雇用存储矿工来存储碎片。</p>
<p>Piece 数据结构设计用于证明任意 IPLD 图和客户端数据的存储。 此图显示了 Piece 及其证明树的详细组成，包括完整和带宽优化的 Piece 数据结构。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://filecoin.io/zh-cn/blog/posts/filecoin-plus-client/">Filecoin Plus: 存储提供者如何与已验证用户互动</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/2021/07/20/macOS-%E8%A7%A3%E5%86%B3-too-many-open-files/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/20/macOS-%E8%A7%A3%E5%86%B3-too-many-open-files/" class="post-title-link" itemprop="url">macOS 解决 too many open files</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-20 14:10:14" itemprop="dateCreated datePublished" datetime="2021-07-20T14:10:14+08:00">2021-07-20</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2021/07/20/macOS-%E8%A7%A3%E5%86%B3-too-many-open-files/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/07/20/macOS-解决-too-many-open-files/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>报错 <code>too many open files</code> 大致有以下三种可能 <a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/108323">[1]</a> <a target="_blank" rel="noopener" href="https://www.launchd.info/">[2]</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Launchd#launchctl">[3]</a>：<br>\1. 操作系统打开的文件句柄数过多（内核的限制）<br>\2. launchd 对进程进行了限制<br>\3. shell 对进程进行了限制</p>
<h2 id="内核的限制"><a href="#内核的限制" class="headerlink" title="内核的限制"></a>内核的限制</h2><p>整个操作系统可以打开的文件数受内核参数影响，可以通过以下命令查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl kern.maxfiles</span><br><span class="line">$ sysctl kern.maxfilesperproc</span><br></pre></td></tr></table></figure>
<p>在我电脑上输出如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kern</span>.maxfiles: <span class="number">49152</span></span><br><span class="line"><span class="attribute">kern</span>.maxfilesperproc: <span class="number">42576</span></span><br></pre></td></tr></table></figure>
<p>好像已经很大了。</p>
<p>如果需要临时修改的话，运行如下命令</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>sudo sysctl -w kern.maxfiles=<span class="number">20480</span> <span class="comment"># 或其他你选择的数字</span></span><br><span class="line"><span class="variable">$ </span>sudo sysctl -w kern.maxfilesperproc=<span class="number">18000</span> <span class="comment"># 或其他你选择的数字</span></span><br></pre></td></tr></table></figure>
<p>永久修改，需要在 <code>/etc/sysctl.conf</code> 里加上类似的下述内容</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kern.maxfiles</span>=<span class="number">20480</span></span><br><span class="line"><span class="attr">kern.maxfilesperproc</span>=<span class="number">18000</span></span><br></pre></td></tr></table></figure>
<p>这个文件可能需要自行创建</p>
<h2 id="launchd-对进程的限制"><a href="#launchd-对进程的限制" class="headerlink" title="launchd 对进程的限制"></a>launchd 对进程的限制</h2><p>获取当前的限制：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">launchctl <span class="built_in">limit</span> maxfiles</span></span><br></pre></td></tr></table></figure>
<p>输出类似这样：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">maxfiles</span>    <span class="number">256</span>            unlimited</span><br></pre></td></tr></table></figure>
<p>其中前一个是软限制，后一个是硬件限制。</p>
<p>临时修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo launchctl <span class="built_in">limit</span> maxfiles 65536 200000</span></span><br></pre></td></tr></table></figure>
<p>系统范围内修改则需要在文件夹 <code>/Library/LaunchDaemons</code> 下创建一个 plist 文件 <code>limit.maxfiles.plist</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">plist</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>Label<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>limit.maxfiles<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>launchctl<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>limit<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>maxfiles<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>65536<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>200000<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>RunAtLoad<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>ServiceIPC<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">false</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改文件权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">chown</span> root:wheel /Library/LaunchDaemons/limit.maxfiles.plist</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">chmod</span> 644 /Library/LaunchDaemons/limit.maxfiles.plist</span></span><br></pre></td></tr></table></figure>
<p>载入新设定</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo launchctl load -w <span class="regexp">/Library/</span>LaunchDaemons/limit.maxfiles.plist</span><br></pre></td></tr></table></figure>
<h2 id="shell-的限制"><a href="#shell-的限制" class="headerlink" title="shell 的限制"></a>shell 的限制</h2><p>通过下述命令查看现有限制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ulimit</span> -a</span></span><br></pre></td></tr></table></figure>
<p>得到如下输出</p>
<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">...</span></span><br><span class="line">-n: file descriptors                256</span><br><span class="line"><span class="meta prompt_">...</span></span><br></pre></td></tr></table></figure>
<p>通过 <code>ulimit -S -n 4096</code> 来修改。如果需要保持修改，可以将这一句命令加入你的 <code>.bash_profile</code> 或 <code>.zshrc</code> 等。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一般来说，修改了上述三个限制，重启一下，这个问题就可以解决了。</p>
<p>在实际操作中，我修改到第二步重启，第三个就自动修改了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/filecoin-provesector-aggregate">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/filecoin-provesector-aggregate" class="post-title-link" itemprop="url">一种推断何时启用FileCoin区块链网络聚合复制证明消息的方法</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-13 15:36:54" itemprop="dateCreated datePublished" datetime="2021-07-13T15:36:54+08:00">2021-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-14 09:11:49" itemprop="dateModified" datetime="2021-07-14T09:11:49+08:00">2021-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/filecoin-provesector-aggregate#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="/filecoin-provesector-aggregate" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>UTC时间 2021-06-30T22:00:00Z FileCoin 区块链主网络升级到 Hyper Drive 版本。</p>
<p><a target="_blank" rel="noopener" href="https://filecoin.io/blog/posts/filecoin-v13-hyperdrive-ama-1-recap/">https://filecoin.io/blog/posts/filecoin-v13-hyperdrive-ama-1-recap/</a></p>
<p><a target="_blank" rel="noopener" href="https://filecoin.io/blog/posts/filecoin-v13-hyperdrive-network-upgrade-unlocks-10-25x-increase-in-storage-onboarding/">https://filecoin.io/blog/posts/filecoin-v13-hyperdrive-network-upgrade-unlocks-10-25x-increase-in-storage-onboarding/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/filecoin-project/FIPs/blob/master/FIPS/fip-0013.md">https://github.com/filecoin-project/FIPs/blob/master/FIPS/fip-0013.md</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/2021/07/06/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E7%9F%BF%E5%B7%A5%E8%B7%91%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/06/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E7%9F%BF%E5%B7%A5%E8%B7%91%E8%B7%AF/" class="post-title-link" itemprop="url">如何判断矿工跑路</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-06 09:10:33" itemprop="dateCreated datePublished" datetime="2021-07-06T09:10:33+08:00">2021-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-13 22:21:01" itemprop="dateModified" datetime="2021-07-13T22:21:01+08:00">2021-07-13</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2021/07/06/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E7%9F%BF%E5%B7%A5%E8%B7%91%E8%B7%AF/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/07/06/如何判断矿工跑路/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>7月5日，FileCoin网络在一段时间内显示的算力增量较前一日相比，下降很明显，全网掉了48P的算力。需要检查全网终止的扇区、故障的扇区和总扇区数的变化。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/filecoin-bitfield-format">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/filecoin-bitfield-format" class="post-title-link" itemprop="url">BitField格式化</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-04 17:06:23 / 修改时间：17:48:52" itemprop="dateCreated datePublished" datetime="2021-07-04T17:06:23+08:00">2021-07-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/FileCoin/" itemprop="url" rel="index"><span itemprop="name">FileCoin</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/filecoin-bitfield-format#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="/filecoin-bitfield-format" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>维基百科上对于BitField是这样解释的：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E6%AE%B5">https://zh.wikipedia.org/wiki/%E4%BD%8D%E6%AE%B5</a></p>
<p><strong>位段</strong>（或称“位域”，Bit field）为一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/数据结构">数据结构</a>，可以把数据以<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/位">位</a>的形式紧凑的储存，并允许程序员对此结构的位进行操作。这种数据结构的好处：</p>
<ul>
<li>可以使数据单元节省储存空间，当程序需要成千上万个数据单元时，这种方法就显得尤为重要。</li>
<li>位段可以很方便的访问一个<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/整數">整数</a>值的部分内容从而可以简化程序源代码。</li>
</ul>
</blockquote>
<p>FileCoin 有一个 具体的实现：[Go-bitfield][<a target="_blank" rel="noopener" href="https://github.com/filecoin-project/go-bitfield">https://github.com/filecoin-project/go-bitfield</a>]</p>
<blockquote>
<p>Advanced RLE+ implementation</p>
</blockquote>
<p>Features iterator based primitives that scale with number of runs instead of number of bits.</p>
<p>这个实现包含一个Run-length-encoder(RLE)。援引维基百科上面的解释：</p>
<blockquote>
<p><strong>游程编码</strong>（英语：run-length encoding，缩写RLE），又称<strong>行程长度编码</strong>或<strong>变动长度编码法</strong>，是一种与资料性质无关的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/无损数据压缩">无损数据压缩</a>技术，基于“使用变动长度的码来取代连续重复出现的原始资料”来实现压缩。</p>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>举例来说，一组资料串”AAAABBBCCDEEEE”，由4个A、3个B、2个C、1个D、4个E组成，经过<strong>变动长度编码法</strong>可将资料压缩为4A3B2C1D4E（由14个单位转成10个单位）。</p>
<p>简言之，其优点在于将重复性高的资料量压缩成小单位；然而，其缺点在于─若该资料出现频率不高，可能导致压缩结果资料量比原始资料大，例如：原始资料”ABCDE”，压缩结果为”1A1B1C1D1E”（由5个单位转成10个单位）。</p>
</blockquote>
<p>知道了以上大体的功能和说明，针对FileCoin其对BitField的实现版本，目标要将保存在BitField内的数据以JSON格式化形式表示出来。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/filecoin-bitfield-format#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/2021/07/03/PostgreSQL-%E5%88%86%E5%8C%BA%E8%A1%A8%E7%9A%84%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/03/PostgreSQL-%E5%88%86%E5%8C%BA%E8%A1%A8%E7%9A%84%E5%9D%91/" class="post-title-link" itemprop="url">PostgreSQL 分区表的坑</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-03 14:06:23" itemprop="dateCreated datePublished" datetime="2021-07-03T14:06:23+08:00">2021-07-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-24 14:24:18" itemprop="dateModified" datetime="2022-02-24T14:24:18+08:00">2022-02-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Database/" itemprop="url" rel="index"><span itemprop="name">Database</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2021/07/03/PostgreSQL-%E5%88%86%E5%8C%BA%E8%A1%A8%E7%9A%84%E5%9D%91/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/07/03/PostgreSQL-分区表的坑/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>某君A 需要在另外一套PostgreSQL数据库中部署一样的数据库表结构。为了偷懒，直接通过图形界面的查询分析器从源数据库中捞出表结构，并在新数据库中创建。数据在新服务器上创建后，发现新服务器无法插入数据，遂找原因，发现是没有找到表索引。查询是查询一张分区表，由于没有在主表上建唯一索引，插入时就找不到相关约束，导致插入失败。在主表上创建唯一索引约束后，插入语句正常工作。</p>
<p>– 2022-02-24 更新</p>
<p>PG11以后的版本，都支持自动创建分区索引功能，只需要在主表上创建相关的索引，所有分区，以及未来创建的新分区表上都会创建相应的索引。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/publish-go-mod-version">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/publish-go-mod-version" class="post-title-link" itemprop="url">Go mod 发布版本</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-03 13:32:23 / 修改时间：13:41:28" itemprop="dateCreated datePublished" datetime="2021-07-03T13:32:23+08:00">2021-07-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/publish-go-mod-version#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="/publish-go-mod-version" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="版本号发布"><a href="#版本号发布" class="headerlink" title="版本号发布"></a>版本号发布</h2><p>Go模块版本只要分为三个部分如<code>&lt;major&gt;.&lt;minor&gt;.&lt;patch&gt;</code>，例如对于v1.0.1,主版本<code>&lt;major&gt;</code>是1，次版本<code>&lt;minor&gt;</code>是0，补丁版本<code>&lt;patch&gt;</code>是1</p>
<p>v0版本为项目的初始版本，版本不保证稳定行，可以通过<code>git tag</code>来标记版本，将tag推送至仓库即可 v1版本为稳定版本，当你的项目稳定之后，可以标记v1版本对外发布；另外对于稳定之后的预发布版本，由于Go命令首选的是正常版本，而不是预发布版本；可以通过<code>-</code>来制定预发布版本，如<code>v1.0.1-beta</code>、<code>v1.0.1-alpha</code>；使用的时候需要显示的指定预发布版本<code>go get github.com/p1024k/helle@v1.0.1-beta</code> 下面看下怎么发布第一个v0.0.1版本：</p>
<h3 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h3><p>首先在你的github仓库创建一个<code>repository</code>，命名为<code>hello</code>，然后将hello项目同步至仓库</p>
<h3 id="标记并推送Tag"><a href="#标记并推送Tag" class="headerlink" title="标记并推送Tag"></a>标记并推送Tag</h3><p>通过git标签维护版本。都以master为主仓库，每开发一个版本从master切换出一个分支开发。然后合并回master主分支。在master主分支上执行以下动作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git tag v0.0.1</span><br><span class="line">git push origin v0.0.1</span><br></pre></td></tr></table></figure>
<h3 id="在其他项目中引用"><a href="#在其他项目中引用" class="headerlink" title="在其他项目中引用"></a>在其他项目中引用</h3><p>在项目中直接导入<code>&quot;github.com/p1024k/hello&quot;</code>，然后通过执行 go mod tiny或者go mod build就可以添加新的依赖了</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/p1024k/hello&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">	fmt.Println(hello.Hello())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>引入依赖之后 cat go.mod，可以看到已经引入了我们自定义的模块</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module study</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="number">1.16</span></span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">        github.com/p1024k/hello v0<span class="number">.0</span><span class="number">.1</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="版本升级"><a href="#版本升级" class="headerlink" title="版本升级"></a>版本升级</h2><p>Go模块中规范了一个重要原则</p>
<p><strong><em>If an old package and a new package have the same import path, the new package must be backwards compatible with the old package.</em></strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果旧包和新包具有相同的导入路径，新包必须向后兼容旧包。</span><br></pre></td></tr></table></figure>
<h3 id="v0-gt-v1"><a href="#v0-gt-v1" class="headerlink" title="v0-&gt;v1"></a>v0-&gt;v1</h3><p>假设我们自定义的模块已经稳定了，那么开始要对外发布v1.0.0版本了</p>
<ol>
<li>拉取新的分支v1.0.0_branch</li>
<li>git tag v1.0.0 并且推送到远程仓库</li>
</ol>
<h3 id="v1-gt-v2"><a href="#v1-gt-v2" class="headerlink" title="v1-&gt;v2"></a>v1-&gt;v2</h3><p>v1-&gt;v2的升级属于主版本的升级（v2不向后兼容）， 这里有两种方式：</p>
<ul>
<li>创建新的版本目录v2</li>
<li>继续使用v0-&gt;v1的升级方式</li>
</ul>
<p><strong>这里只讲在V1-&gt;V2的情况。且只讲继续使用V0-&gt;v1的升级方式。</strong></p>
<p>拉取新的分支，修改go.mod路径为<code>github.com/p1024k/hello/v2</code>，基于master分支打tag v2.0.0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># checkout from master</span></span><br><span class="line">git checkout -b v2</span><br><span class="line">go mod edit -module github.com/youdw/hello/v2</span><br><span class="line">...</span><br><span class="line"><span class="comment"># make some change</span></span><br><span class="line">git push</span><br><span class="line">git checkout master</span><br><span class="line">git rebase v2</span><br><span class="line">git tag v2.0.0</span><br><span class="line">git push origin master</span><br><span class="line">git push --tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># git push origin v2.0.0</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://alpha.checkitout.dev/multi-git-accounts">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="alpha">
      <meta itemprop="description" content="记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Check it out">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/multi-git-accounts" class="post-title-link" itemprop="url">本地支持多Github账号</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-03 12:06:23 / 修改时间：13:55:18" itemprop="dateCreated datePublished" datetime="2021-07-03T12:06:23+08:00">2021-07-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/%E5%B8%AE%E5%8A%A9%E6%89%8B%E5%86%8C/" itemprop="url" rel="index"><span itemprop="name">帮助手册</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/multi-git-accounts#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="/multi-git-accounts" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="创建非默认本地SSH密钥"><a href="#创建非默认本地SSH密钥" class="headerlink" title="创建非默认本地SSH密钥"></a>创建非默认本地SSH密钥</h2><p>GitHub不支持相同SSH Key在不同GitHub账户下使用。所以除默认账户外，需要单独为新GitHub账号建立一个SSH Key。注意，使用<code>ssh-keygen</code>生成新key，出现提示输入文件名的时候(<code>Enter file in which to save the key (~/.ssh/id_rsa): id_rsa_new</code>)要输入与默认配置不一样的文件名，比如：我这里填的是 <code>id_rsa_new</code>。否则会覆盖之前生成的默认key。并用<code>ssh-add</code>命令将新创建的Key添加到由<code>ssh-agent</code> 维护的列表中。</p>
<blockquote>
<p>ssh-agent 是用于管理SSH private keys的, 长时间持续运行的守护进程（daemon）. 唯一目的就是对解密的私钥进行高速缓存。</p>
<p>ssh-add 提示并将用户的使用的私钥添加到由ssh-agent 维护的列表中. 此后, 当使用公钥连接到远程 SSH 或 SCP 主机时,不再提示相关信息.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 2048 -C <span class="string">&quot;xxx@xxx.com&quot;</span></span><br><span class="line">ssh-add ~/.ssh/id_rsa_new</span><br></pre></td></tr></table></figure>
<p>如果出现 <strong>Could not open a connection to your authentication agent</strong> 的错误，就试着用以下命令：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>ssh-agent bash</span><br><span class="line"><span class="variable">$ </span>ssh-add ~<span class="regexp">/.ssh/id</span>_rsa_new</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/multi-git-accounts#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="alpha"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">alpha</p>
  <div class="site-description" itemprop="description">记录工作中研究和学习的内容，把他们以文字的形式记录下来，备忘。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/alphaqiu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;alphaqiu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:alphaqiu@gmail.com" title="E-Mail → mailto:alphaqiu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">alpha</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v6.3.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://alphaqiu.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
